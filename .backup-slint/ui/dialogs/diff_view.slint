import { Theme, DiffLineItem, CategoryDiffItem } from "../styles.slint";
import { Button, ScrollView } from "std-widgets.slint";

// Dialog to show config changes before saving
export component DiffViewDialog inherits Rectangle {
    // Whether the dialog is visible
    in-out property <bool> show-dialog: false;
    // List of category diffs
    in property <[CategoryDiffItem]> categories: [];
    // Total stats
    in property <int> total-additions: 0;
    in property <int> total-deletions: 0;
    // Currently expanded category
    in-out property <int> expanded-category-index: 0;

    // Callbacks
    callback save-now();
    callback discard-all();
    callback close-dialog();

    // Cover the full window
    visible: root.show-dialog;
    background: Theme.overlay-background.with-alpha(0.8);

    // Block clicks to background
    TouchArea {}

    // Dialog card
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: min(parent.width - 48px, 700px);
        height: min(parent.height - 48px, 600px);
        background: Theme.card-background;
        border-radius: Theme.radius-lg;
        border-width: 1px;
        border-color: Theme.border;

        VerticalLayout {
            padding: Theme.panel-padding;
            spacing: Theme.spacing-md;

            // Header
            HorizontalLayout {
                spacing: Theme.spacing-md;

                Text {
                    text: "Review Changes";
                    color: Theme.text-primary;
                    font-size: Theme.font-size-xl;
                    font-weight: 700;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }

                // Stats badges
                if root.total-additions > 0: Rectangle {
                    width: 60px;
                    height: 24px;
                    background: Theme.success.with-alpha(0.2);
                    border-radius: Theme.radius-sm;

                    Text {
                        text: "+" + root.total-additions;
                        color: Theme.success;
                        font-size: Theme.font-size-sm;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                if root.total-deletions > 0: Rectangle {
                    width: 60px;
                    height: 24px;
                    background: Theme.error.with-alpha(0.2);
                    border-radius: Theme.radius-sm;

                    Text {
                        text: "-" + root.total-deletions;
                        color: Theme.error;
                        font-size: Theme.font-size-sm;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }

            // Description
            Text {
                text: root.categories.length > 0 ?
                    "The following changes will be saved to your config files:" :
                    "No pending changes to review.";
                color: Theme.text-secondary;
                font-size: Theme.font-size-sm;
            }

            // Category list with expandable diffs
            ScrollView {
                vertical-stretch: 1;

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    for cat[idx] in root.categories: Rectangle {
                        background: Theme.surface-elevated;
                        border-radius: Theme.radius-md;

                        VerticalLayout {
                            // Category header (clickable)
                            Rectangle {
                                height: 48px;
                                background: header-touch.has-hover ? Theme.card-background : transparent;
                                border-radius: Theme.radius-md;

                                header-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        if root.expanded-category-index == idx {
                                            root.expanded-category-index = -1;
                                        } else {
                                            root.expanded-category-index = idx;
                                        }
                                    }
                                }

                                HorizontalLayout {
                                    padding: Theme.spacing-sm;
                                    spacing: Theme.spacing-sm;

                                    // Expand indicator
                                    Text {
                                        text: root.expanded-category-index == idx ? "\u{25bc}" : "\u{25b6}";
                                        color: Theme.text-muted;
                                        font-size: Theme.font-size-xs;
                                        width: 16px;
                                        vertical-alignment: center;
                                    }

                                    // Category name
                                    Text {
                                        text: cat.name;
                                        color: Theme.text-primary;
                                        font-size: Theme.font-size-md;
                                        font-weight: 600;
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    // Stats
                                    if cat.additions > 0: Rectangle {
                                        width: 40px;
                                        height: 20px;
                                        background: Theme.success.with-alpha(0.2);
                                        border-radius: Theme.radius-sm;

                                        Text {
                                            text: "+" + cat.additions;
                                            color: Theme.success;
                                            font-size: Theme.font-size-xs;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    if cat.deletions > 0: Rectangle {
                                        width: 40px;
                                        height: 20px;
                                        background: Theme.error.with-alpha(0.2);
                                        border-radius: Theme.radius-sm;

                                        Text {
                                            text: "-" + cat.deletions;
                                            color: Theme.error;
                                            font-size: Theme.font-size-xs;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }

                            // Expanded diff content
                            if root.expanded-category-index == idx: Rectangle {
                                background: Theme.background;
                                border-radius: Theme.radius-sm;

                                VerticalLayout {
                                    padding: Theme.spacing-sm;

                                    // File path
                                    Text {
                                        text: cat.file-path;
                                        color: Theme.text-muted;
                                        font-size: Theme.font-size-xs;
                                    }

                                    // Diff lines
                                    for line in cat.lines: Rectangle {
                                        height: 20px;
                                        background: line.line-type == 1 ? Theme.success.with-alpha(0.1) :
                                                   line.line-type == 2 ? Theme.error.with-alpha(0.1) :
                                                   transparent;

                                        HorizontalLayout {
                                            spacing: Theme.spacing-xs;

                                            // Line number
                                            Text {
                                                text: line.line-num;
                                                color: Theme.text-muted;
                                                font-size: Theme.font-size-xs;
                                                width: 30px;
                                                horizontal-alignment: right;
                                            }

                                            // Change indicator
                                            Text {
                                                text: line.line-type == 1 ? "+" :
                                                      line.line-type == 2 ? "-" : " ";
                                                color: line.line-type == 1 ? Theme.success :
                                                       line.line-type == 2 ? Theme.error :
                                                       Theme.text-muted;
                                                font-size: Theme.font-size-xs;
                                                width: 12px;
                                                font-weight: 700;
                                            }

                                            // Content
                                            Text {
                                                text: line.line-type == 2 ? line.old-text : line.new-text;
                                                color: line.line-type == 1 ? Theme.success :
                                                       line.line-type == 2 ? Theme.error :
                                                       Theme.text-secondary;
                                                font-size: Theme.font-size-xs;
                                                horizontal-stretch: 1;
                                                overflow: elide;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Empty state
                    if root.categories.length == 0: Rectangle {
                        height: 100px;

                        VerticalLayout {
                            alignment: center;

                            Text {
                                text: "No pending changes";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-md;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: "Your settings match the saved config files.";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-xs;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }
            }

            // Action buttons
            HorizontalLayout {
                spacing: Theme.spacing-sm;
                alignment: end;

                Button {
                    text: "Close";
                    clicked => { root.close-dialog(); }
                }

                if root.categories.length > 0: Button {
                    text: "Discard All";
                    clicked => { root.discard-all(); }
                }

                if root.categories.length > 0: Button {
                    text: "Save Now";
                    clicked => { root.save-now(); }
                }
            }
        }
    }
}
