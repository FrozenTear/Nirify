// First-run wizard dialog
import { Button, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { Theme } from "../styles.slint";

export component FirstRunWizard inherits Rectangle {
    in property <bool> show-wizard: false;
    in-out property <int> current-step: 0;
    in property <bool> has-include-line: false;
    in property <string> config-path: "~/.config/niri/config.kdl";
    in property <string> include-line: "include \"niri-settings/main.kdl\"";

    // Import summary properties
    in property <string> import-summary: "";
    in property <bool> has-imports: false;

    callback wizard-completed();
    callback wizard-cancelled();
    callback add-include-line-requested();

    property <int> total-steps: 3;

    // Only render when visible - prevents blocking clicks
    visible: show-wizard;

    // Modal overlay
    background: Theme.overlay-background.with-alpha(0.82);

    // Block clicks on the overlay background
    TouchArea {}

    // Dialog box
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: min(550px, parent.width - 40px);
        height: min(450px, parent.height - 40px);
        background: Theme.card-background;
        border-radius: Theme.radius-lg;
        drop-shadow-blur: 30px;
        drop-shadow-color: Theme.panel-shadow-color.with-alpha(0.38);

        VerticalLayout {
            padding: Theme.spacing-lg;
            spacing: Theme.spacing-md;

            // Progress indicator
            HorizontalLayout {
                height: 8px;
                spacing: Theme.spacing-xs;

                for step in total-steps: Rectangle {
                    horizontal-stretch: 1;
                    background: step <= current-step ? Theme.accent : Theme.border;
                    border-radius: 4px;
                }
            }

            // Step content
            Rectangle {
                vertical-stretch: 1;

                // Step 0: Welcome
                if current-step == 0: VerticalLayout {
                    spacing: Theme.spacing-lg;
                    alignment: center;

                    Text {
                        text: "Welcome to Niri Settings";
                        color: Theme.text-primary;
                        font-size: 28px;
                        font-weight: 700;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "This application helps you configure niri, the scrollable-tiling Wayland compositor, without editing config files directly.";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-lg;
                        wrap: word-wrap;
                        horizontal-alignment: center;
                    }

                    Rectangle { height: Theme.spacing-lg; }

                    // Centered container for left-aligned list
                    HorizontalLayout {
                        alignment: center;

                        VerticalLayout {
                            spacing: Theme.spacing-sm;

                            HorizontalLayout {
                                spacing: Theme.spacing-sm;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: Theme.success;
                                    y: 5px;
                                }
                                Text {
                                    text: "Live preview - changes apply immediately";
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-md;
                                }
                            }

                            HorizontalLayout {
                                spacing: Theme.spacing-sm;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: Theme.success;
                                    y: 5px;
                                }
                                Text {
                                    text: "Safe - backups created before any changes";
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-md;
                                }
                            }

                            HorizontalLayout {
                                spacing: Theme.spacing-sm;

                                Rectangle {
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 4px;
                                    background: Theme.success;
                                    y: 5px;
                                }
                                Text {
                                    text: "Organized - settings stored in separate files";
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-md;
                                }
                            }
                        }
                    }
                }

                // Step 1: Include line setup
                if current-step == 1: VerticalLayout {
                    spacing: Theme.spacing-lg;

                    Text {
                        text: "Connect to Your Config";
                        color: Theme.text-primary;
                        font-size: 24px;
                        font-weight: 600;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Niri Settings manages common settings (layout, input, appearance). Your custom settings will be preserved.";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-md;
                        wrap: word-wrap;
                    }

                    Rectangle { height: Theme.spacing-sm; }

                    // Include line display
                    Rectangle {
                        background: Theme.background;
                        border-radius: Theme.radius-md;
                        height: 60px;

                        Text {
                            x: Theme.spacing-md;
                            y: Theme.spacing-md;
                            text: include-line;
                            color: Theme.accent;
                            font-size: Theme.font-size-md;
                            font-family: "monospace";
                        }
                    }

                    Rectangle { height: Theme.spacing-sm; }

                    if has-include-line: HorizontalLayout {
                        spacing: Theme.spacing-sm;
                        alignment: center;

                        Rectangle {
                            width: 20px;
                            height: 20px;
                            border-radius: 10px;
                            background: Theme.success;

                            Text {
                                text: "+";
                                color: Theme.success-foreground;
                                font-size: 14px;
                                font-weight: 700;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                        Text {
                            text: "Already configured! Your config includes our settings.";
                            color: Theme.success;
                            font-size: Theme.font-size-md;
                        }
                    }

                    if !has-include-line: VerticalLayout {
                        spacing: Theme.spacing-md;

                        Text {
                            text: "Choose how to add this line:";
                            color: Theme.text-secondary;
                            font-size: Theme.font-size-md;
                        }

                        HorizontalLayout {
                            spacing: Theme.spacing-md;

                            Button {
                                text: "Add Automatically";
                                horizontal-stretch: 1;
                                clicked => {
                                    add-include-line-requested();
                                }
                            }

                            Button {
                                text: "I'll Add It Myself";
                                horizontal-stretch: 1;
                                clicked => {
                                    current-step = 2;
                                }
                            }
                        }

                        Text {
                            text: "This will reorganize " + config-path + " and create a backup";
                            color: Theme.text-muted;
                            font-size: Theme.font-size-sm;
                            wrap: word-wrap;
                        }
                    }
                }

                // Step 2: Complete
                if current-step == 2: VerticalLayout {
                    spacing: Theme.spacing-md;
                    alignment: center;

                    Rectangle {
                        width: 64px;
                        height: 64px;
                        border-radius: 32px;
                        background: Theme.success;

                        Text {
                            text: "âœ“";
                            color: Theme.success-foreground;
                            font-size: 32px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    Text {
                        text: "You're All Set!";
                        color: Theme.text-primary;
                        font-size: 24px;
                        font-weight: 700;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: has-include-line ?
                              "Your configuration is connected. Changes apply immediately when niri reloads." :
                              "Remember to add the include line to your config.kdl before changes take effect.";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-md;
                        wrap: word-wrap;
                        horizontal-alignment: center;
                    }

                    // Import summary section
                    if has-imports: Rectangle {
                        background: Theme.background;
                        border-radius: Theme.radius-md;
                        height: 80px;

                        VerticalLayout {
                            padding: Theme.spacing-md;
                            spacing: Theme.spacing-xs;

                            Text {
                                text: "Imported from your config:";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-sm;
                            }

                            Text {
                                text: import-summary;
                                color: Theme.text-secondary;
                                font-size: Theme.font-size-md;
                                wrap: word-wrap;
                            }
                        }
                    }

                    if !has-imports: Text {
                        text: "Using default settings (no existing config found)";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Tip: Press Super+Shift+R to reload niri's config.";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                        horizontal-alignment: center;
                    }
                }
            }

            // Navigation buttons
            HorizontalLayout {
                spacing: Theme.spacing-md;

                // Skip/Cancel button
                if current-step < 2: Button {
                    text: "Skip Setup";
                    clicked => {
                        wizard-cancelled();
                    }
                }

                Rectangle { horizontal-stretch: 1; }

                // Back button
                if current-step > 0 && current-step < 2: Button {
                    text: "Back";
                    clicked => {
                        current-step = current-step - 1;
                    }
                }

                // Next/Continue button
                if current-step == 0: Button {
                    text: "Get Started";
                    clicked => {
                        current-step = 1;
                    }
                }

                if current-step == 1 && has-include-line: Button {
                    text: "Continue";
                    clicked => {
                        current-step = 2;
                    }
                }

                // Finish button
                if current-step == 2: Button {
                    text: "Start Using Niri Settings";
                    clicked => {
                        wizard-completed();
                    }
                }
            }
        }
    }
}
