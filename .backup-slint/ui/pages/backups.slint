import { Theme } from "../styles.slint";
import { ScrollView, Button, ListView } from "std-widgets.slint";
import { SettingsSection } from "../widgets/section.slint";
import { ConfirmDialog } from "../dialogs/confirm_dialog.slint";

// Backup entry for the list
export struct BackupEntry {
    filename: string,
    date: string,
    size: string,
}

// Backup browser page
export component BackupsPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Backups";

    in-out property <[BackupEntry]> backup-list: [];
    in-out property <int> selected-backup-index: -1;
    in-out property <string> preview-content: "";
    in-out property <string> status-message: "";
    in-out property <bool> has-backups: false;

    callback refresh-requested();
    callback preview-requested(int);
    callback restore-requested(int);

    // Internal state for confirmation dialog
    property <bool> show-restore-confirm: false;
    property <int> restore-pending-index: -1;

    background: transparent;

    ScrollView {
        VerticalLayout {
            alignment: start;
            spacing: Theme.spacing-lg;
            padding-right: Theme.spacing-md;

            // Info banner
            Rectangle {
                background: Theme.info.with-alpha(0.15);
                border-radius: Theme.radius-md;
                border-width: 1px;
                border-color: Theme.info.with-alpha(0.3);
                height: 48px;

                HorizontalLayout {
                    padding: Theme.spacing-md;
                    spacing: Theme.spacing-sm;

                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: Theme.info;
                        y: (parent.height - self.height) / 2;
                    }

                    Text {
                        text: "Backups are created when modifying your main niri config.";
                        color: Theme.info;
                        font-size: Theme.font-size-md;
                        vertical-alignment: center;
                    }
                }
            }

            // Backup list section
            SettingsSection {
                title: "AVAILABLE BACKUPS";

                VerticalLayout {
                    spacing: Theme.spacing-md;

                    HorizontalLayout {
                        spacing: Theme.spacing-md;

                        Button {
                            text: "Refresh List";
                            clicked => { root.refresh-requested(); }
                        }

                        Text {
                            text: root.status-message;
                            color: Theme.text-secondary;
                            font-size: Theme.font-size-sm;
                            vertical-alignment: center;
                        }
                    }

                    if !root.has-backups: Rectangle {
                        background: Theme.card-background;
                        border-radius: Theme.radius-md;
                        height: 80px;

                        Text {
                            text: "No backups found. Backups are created when config.kdl is modified.";
                            color: Theme.text-muted;
                            font-size: Theme.font-size-md;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    if root.has-backups: Rectangle {
                        background: Theme.card-background;
                        border-radius: Theme.radius-md;
                        border-width: 1px;
                        border-color: Theme.border;
                        min-height: 200px;
                        max-height: 300px;

                        ListView {
                            for entry[idx] in root.backup-list: Rectangle {
                                height: 56px;
                                background: idx == root.selected-backup-index ? Theme.selection-background : transparent;
                                border-radius: Theme.radius-sm;

                                HorizontalLayout {
                                    padding: Theme.spacing-md;
                                    spacing: Theme.spacing-md;

                                    // Clickable text area for row selection
                                    TouchArea {
                                        horizontal-stretch: 1;
                                        accessible-role: list-item;
                                        accessible-label: "Backup: " + entry.filename + ", created " + entry.date;

                                        clicked => {
                                            root.selected-backup-index = idx;
                                        }

                                        VerticalLayout {
                                            spacing: 4px;

                                            Text {
                                                text: entry.filename;
                                                color: Theme.text-primary;
                                                font-size: Theme.font-size-md;
                                                overflow: elide;
                                            }

                                            HorizontalLayout {
                                                spacing: Theme.spacing-md;

                                                Text {
                                                    text: entry.date;
                                                    color: Theme.text-secondary;
                                                    font-size: Theme.font-size-sm;
                                                }

                                                Text {
                                                    text: entry.size;
                                                    color: Theme.text-muted;
                                                    font-size: Theme.font-size-sm;
                                                }
                                            }
                                        }
                                    }

                                    Button {
                                        text: "Preview";
                                        clicked => {
                                            root.selected-backup-index = idx;
                                            root.preview-requested(idx);
                                        }
                                    }

                                    Button {
                                        text: "Restore";
                                        clicked => {
                                            root.selected-backup-index = idx;
                                            root.restore-pending-index = idx;
                                            root.show-restore-confirm = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Preview section
            if root.preview-content != "": SettingsSection {
                title: root.selected-backup-index >= 0 && root.selected-backup-index < root.backup-list.length ?
                    "PREVIEW: " + root.backup-list[root.selected-backup-index].filename : "PREVIEW";

                Rectangle {
                    background: Theme.card-background;
                    border-radius: Theme.radius-md;
                    border-width: 1px;
                    border-color: Theme.border;
                    min-height: 300px;

                    ScrollView {
                        VerticalLayout {
                            padding: Theme.spacing-md;

                            Text {
                                text: root.preview-content;
                                color: Theme.text-primary;
                                font-size: Theme.font-size-sm;
                                font-family: "monospace";
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }

            // Spacer at bottom
            Rectangle { height: Theme.spacing-lg; }
        }
    }

    // Confirmation dialog for restore
    ConfirmDialog {
        show-dialog: root.show-restore-confirm;
        title: "Restore Backup?";
        message: root.restore-pending-index >= 0 && root.restore-pending-index < root.backup-list.length ?
            "This will restore " + root.backup-list[root.restore-pending-index].filename + " and overwrite your current configuration." :
            "This will restore the selected backup and overwrite your current configuration.";
        warning: "Your current niri config will be replaced. A backup of your current config will be created before restoring.";
        confirm-text: "Restore Backup";
        cancel-text: "Cancel";

        confirmed => {
            root.show-restore-confirm = false;
            if root.restore-pending-index >= 0 {
                root.restore-requested(root.restore-pending-index);
            }
            root.restore-pending-index = -1;
        }

        cancelled => {
            root.show-restore-confirm = false;
            root.restore-pending-index = -1;
        }
    }
}
