import { Theme, KeyPart } from "../styles.slint";
import { ScrollView, Button, LineEdit, ComboBox, CheckBox, SpinBox } from "std-widgets.slint";
import { SettingsSection, SettingRow } from "../widgets/section.slint";
import { KeyBadges } from "../widgets/key_badges.slint";
import { KeyCaptureInput } from "../widgets/key_capture.slint";

// Data structure for a keybinding displayed in the list
export struct KeybindingItem {
    id: int,
    key-combo: string,
    key-parts: [KeyPart],  // Parsed parts for badge display
    display-name: string,
    action-type: string,  // "spawn", "niri", "niri-args"
    action-detail: string,
    allow-when-locked: bool,
    has-cooldown: bool,
    cooldown-ms: int,
    repeat: bool,
}

// Keybindings page with full editing support
export component KeybindingsPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Keybindings";

    // List of keybindings
    in-out property <[KeybindingItem]> keybindings: [];
    in-out property <int> selected-index: -1;
    in-out property <bool> loaded: false;
    in-out property <string> source-file: "";
    in-out property <string> error-message: "";

    // Editor state
    in-out property <bool> editor-visible: false;
    in-out property <string> edit-key-combo: "";
    in-out property <[KeyPart]> edit-key-parts: [];  // Parsed parts for badge display
    in-out property <string> edit-overlay-title: "";
    in-out property <bool> edit-allow-when-locked: false;
    in-out property <bool> edit-repeat: false;
    in-out property <int> edit-cooldown: 0;
    in-out property <int> edit-action-type: 0;  // 0=spawn, 1=niri, 2=niri-args
    in-out property <string> edit-action-command: "";
    in-out property <string> edit-action-name: "";

    // Callbacks
    callback refresh-keybindings();
    callback keybinding-selected(int);
    callback keybinding-add();
    callback keybinding-edit();
    callback keybinding-delete(int);
    callback keybindings-import();
    callback keybindings-import-from-file();
    callback keybinding-editor-close();
    callback key-combo-changed(string);
    callback raw-key-pressed(/* text */ string, /* meta */ bool, /* ctrl */ bool, /* alt */ bool, /* shift */ bool);
    callback action-type-changed(int);
    callback action-command-changed(string);
    callback action-name-changed(string);
    callback allow-when-locked-changed(bool);
    callback repeat-changed(bool);
    callback cooldown-changed(int);
    callback overlay-title-changed(string);

    background: transparent;

    HorizontalLayout {
        spacing: Theme.spacing-md;

        // Keybindings list panel
        Rectangle {
            width: Theme.panel-width-narrow;
            background: Theme.card-background;
            border-radius: Theme.radius-md;

            VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-sm;

                // Header row
                HorizontalLayout {
                    spacing: Theme.spacing-xs;
                    height: 36px;

                    Text {
                        text: "Keybindings";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-md;
                        font-weight: 600;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: "+";
                        width: 32px;
                        accessible-label: "Add new keybinding";
                        clicked => { root.keybinding-add(); }
                    }
                }

                // Action buttons row
                HorizontalLayout {
                    spacing: Theme.spacing-xs;

                    Button {
                        text: "Import File";
                        horizontal-stretch: 1;
                        accessible-label: "Import keybindings from a file";
                        clicked => { root.keybindings-import-from-file(); }
                    }

                    Button {
                        text: "Refresh";
                        horizontal-stretch: 1;
                        accessible-label: "Reload keybindings from config";
                        clicked => { root.refresh-keybindings(); }
                    }
                }

                // Source file info
                if root.source-file != "": Text {
                    text: "Source: " + root.source-file;
                    color: Theme.text-muted;
                    font-size: Theme.font-size-xs;
                    overflow: elide;
                }

                // Error message
                if root.error-message != "": Rectangle {
                    background: Theme.error.with-alpha(0.1);
                    border-radius: Theme.radius-sm;
                    height: 40px;

                    HorizontalLayout {
                        padding: Theme.spacing-sm;

                        Text {
                            text: root.error-message;
                            color: Theme.error;
                            font-size: Theme.font-size-sm;
                            vertical-alignment: center;
                            wrap: word-wrap;
                        }
                    }
                }

                // Keybindings list
                ScrollView {
                    vertical-stretch: 1;

                    VerticalLayout {
                        spacing: Theme.spacing-xs;

                        for binding[index] in root.keybindings : Rectangle {
                            height: 48px;
                            background: index == root.selected-index ? Theme.accent.with-alpha(0.2) :
                                       touch.has-hover ? Theme.surface-elevated : transparent;
                            border-radius: Theme.radius-sm;

                            touch := TouchArea {
                                accessible-role: list-item;
                                accessible-label: "Keybinding: " + binding.key-combo + ", " + binding.display-name;

                                clicked => {
                                    root.selected-index = index;
                                    root.keybinding-selected(index);
                                }
                                double-clicked => {
                                    root.selected-index = index;
                                    root.keybinding-selected(index);
                                    root.keybinding-edit();
                                }
                            }

                            HorizontalLayout {
                                padding-left: Theme.spacing-sm;
                                padding-right: Theme.spacing-sm;

                                VerticalLayout {
                                    alignment: center;
                                    spacing: 2px;
                                    horizontal-stretch: 1;

                                    // Key combination as badges
                                    KeyBadges {
                                        parts: binding.key-parts;
                                    }

                                    // Display name (muted)
                                    Text {
                                        text: binding.display-name;
                                        color: Theme.text-muted;
                                        font-size: Theme.font-size-xs;
                                        overflow: elide;
                                    }
                                }

                                // Indicator badges
                                HorizontalLayout {
                                    spacing: 4px;
                                    alignment: center;

                                    if binding.allow-when-locked: Rectangle {
                                        width: 16px;
                                        height: 16px;
                                        background: Theme.warning.with-alpha(0.2);
                                        border-radius: 8px;

                                        Text {
                                            text: "L";
                                            color: Theme.warning;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    if binding.repeat: Rectangle {
                                        width: 16px;
                                        height: 16px;
                                        background: Theme.info.with-alpha(0.2);
                                        border-radius: 8px;

                                        Text {
                                            text: "R";
                                            color: Theme.info;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                        }

                        // Empty state
                        if root.keybindings.length == 0 && root.error-message == "": Rectangle {
                            height: 120px;

                            VerticalLayout {
                                alignment: center;
                                spacing: Theme.spacing-sm;

                                Text {
                                    text: root.loaded ? "No keybindings yet" : "Loading...";
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-sm;
                                    horizontal-alignment: center;
                                }

                                if root.loaded: Text {
                                    text: "Click + to add or Import to load from config";
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-xs;
                                    horizontal-alignment: center;
                                }
                            }
                        }
                    }
                }

                // Count footer
                if root.keybindings.length > 0: Text {
                    text: root.keybindings.length + " keybindings";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-xs;
                    horizontal-alignment: center;
                }
            }
        }

        // Details/Editor panel
        Rectangle {
            horizontal-stretch: 1;

            if root.editor-visible: ScrollView {
                // Editor mode
                VerticalLayout {
                    spacing: Theme.spacing-lg;
                    padding-right: Theme.spacing-md;

                    // Editor header
                    HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Text {
                            text: "Edit Keybinding";
                            color: Theme.text-primary;
                            font-size: Theme.font-size-lg;
                            font-weight: 600;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }

                        Button {
                            text: "Done";
                            clicked => { root.keybinding-editor-close(); }
                        }
                    }

                    // Key combination
                    SettingsSection {
                        title: "KEY COMBINATION";

                        VerticalLayout {
                            spacing: Theme.spacing-sm;

                            Text {
                                text: "Click to capture a key combination, or type manually";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-xs;
                            }

                            HorizontalLayout {
                                spacing: Theme.spacing-sm;

                                // Key capture widget
                                KeyCaptureInput {
                                    key-combo <=> root.edit-key-combo;
                                    key-parts <=> root.edit-key-parts;
                                    placeholder: "Click to capture keys...";
                                    horizontal-stretch: 1;

                                    key-captured(combo) => {
                                        root.key-combo-changed(combo);
                                    }

                                    raw-key-pressed(text, meta, ctrl, alt, shift) => {
                                        root.raw-key-pressed(text, meta, ctrl, alt, shift);
                                    }
                                }

                                // Manual edit fallback
                                LineEdit {
                                    text: root.edit-key-combo;
                                    placeholder-text: "Or type: Mod+...";
                                    width: 150px;
                                    edited(value) => { root.key-combo-changed(value); }
                                }
                            }

                            // Help text for XF86 keys
                            Text {
                                text: "For media keys, type manually: XF86AudioMute, XF86AudioRaiseVolume, etc.";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-xs;
                                wrap: word-wrap;
                            }
                        }
                    }

                    // Action
                    SettingsSection {
                        title: "ACTION";

                        VerticalLayout {
                            spacing: Theme.spacing-md;

                            SettingRow {
                                label: "Action Type";
                                description: "What kind of action to perform";

                                ComboBox {
                                    model: ["Spawn Command", "Niri Action", "Niri Action (with args)"];
                                    current-index <=> root.edit-action-type;
                                    selected(text) => { root.action-type-changed(self.current-index); }
                                }
                            }

                            if root.edit-action-type == 0: SettingRow {
                                label: "Command";
                                description: "The command to execute (with arguments)";

                                LineEdit {
                                    text: root.edit-action-command;
                                    placeholder-text: "command arg1 arg2";
                                    edited(value) => { root.action-command-changed(value); }
                                }
                            }

                            if root.edit-action-type >= 1: SettingRow {
                                label: "Action Name";
                                description: "The niri action to execute";

                                LineEdit {
                                    text: root.edit-action-name;
                                    placeholder-text: "close-window";
                                    edited(value) => { root.action-name-changed(value); }
                                }
                            }

                            if root.edit-action-type == 2: SettingRow {
                                label: "Arguments";
                                description: "Arguments for the niri action";

                                LineEdit {
                                    text: root.edit-action-command;
                                    placeholder-text: "arg1 arg2";
                                    edited(value) => { root.action-command-changed(value); }
                                }
                            }
                        }
                    }

                    // Properties
                    SettingsSection {
                        title: "PROPERTIES";

                        VerticalLayout {
                            spacing: Theme.spacing-md;

                            SettingRow {
                                label: "Overlay Title";
                                description: "Title shown in niri's hotkey overlay (optional)";

                                LineEdit {
                                    text: root.edit-overlay-title;
                                    placeholder-text: "My Keybinding";
                                    edited(value) => { root.overlay-title-changed(value); }
                                }
                            }

                            SettingRow {
                                label: "Allow When Locked";
                                description: "Works even when screen is locked";

                                CheckBox {
                                    checked: root.edit-allow-when-locked;
                                    toggled => { root.allow-when-locked-changed(self.checked); }
                                }
                            }

                            SettingRow {
                                label: "Repeat When Held";
                                description: "Repeats the action while key is held";

                                CheckBox {
                                    checked: root.edit-repeat;
                                    toggled => { root.repeat-changed(self.checked); }
                                }
                            }

                            SettingRow {
                                label: "Cooldown (ms)";
                                description: "Minimum time between activations (0 = none)";

                                SpinBox {
                                    value: root.edit-cooldown;
                                    minimum: 0;
                                    maximum: 10000;
                                    edited(value) => { root.cooldown-changed(value); }
                                }
                            }
                        }
                    }

                    // Delete button
                    if root.selected-index >= 0: Rectangle {
                        height: 48px;

                        Button {
                            text: "Delete Keybinding";
                            clicked => {
                                root.keybinding-delete(root.selected-index);
                            }
                        }
                    }

                    // Spacer
                    Rectangle { height: Theme.spacing-lg; }
                }
            }

            if !root.editor-visible && root.selected-index >= 0 && root.selected-index < root.keybindings.length: ScrollView {
                // View mode
                VerticalLayout {
                    spacing: Theme.spacing-lg;
                    padding-right: Theme.spacing-md;

                    // Header with edit button
                    HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Text {
                            text: "Keybinding Details";
                            color: Theme.text-primary;
                            font-size: Theme.font-size-lg;
                            font-weight: 600;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }

                        Button {
                            text: "Edit";
                            clicked => { root.keybinding-edit(); }
                        }

                        Button {
                            text: "Delete";
                            clicked => { root.keybinding-delete(root.selected-index); }
                        }
                    }

                    // Key combination header
                    SettingsSection {
                        title: "KEY COMBINATION";

                        Rectangle {
                            background: Theme.surface-elevated;
                            border-radius: Theme.radius-md;
                            height: 60px;

                            HorizontalLayout {
                                padding: Theme.spacing-md;
                                alignment: center;

                                KeyBadges {
                                    parts: root.keybindings[root.selected-index].key-parts;
                                }
                            }
                        }
                    }

                    // Action details
                    SettingsSection {
                        title: "ACTION";

                        VerticalLayout {
                            spacing: Theme.spacing-sm;

                            SettingRow {
                                label: "Type";
                                description: "What kind of action this binding triggers";

                                Text {
                                    text: root.keybindings[root.selected-index].action-type == "spawn" ? "Spawn Command" :
                                          root.keybindings[root.selected-index].action-type == "niri" ? "Niri Action" :
                                          "Niri Action (with args)";
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-sm;
                                }
                            }

                            SettingRow {
                                label: "Details";
                                description: "The command or action to execute";

                                Text {
                                    text: root.keybindings[root.selected-index].action-detail;
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-sm;
                                    wrap: word-wrap;
                                    max-width: 300px;
                                }
                            }
                        }
                    }

                    // Properties
                    SettingsSection {
                        title: "PROPERTIES";

                        VerticalLayout {
                            spacing: Theme.spacing-sm;

                            if root.keybindings[root.selected-index].display-name != root.keybindings[root.selected-index].action-detail: SettingRow {
                                label: "Overlay title";
                                description: "Title shown in niri's hotkey overlay";

                                Text {
                                    text: root.keybindings[root.selected-index].display-name;
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-sm;
                                }
                            }

                            SettingRow {
                                label: "Allow when locked";
                                description: "Works even when screen is locked";

                                Text {
                                    text: root.keybindings[root.selected-index].allow-when-locked ? "Yes" : "No";
                                    color: root.keybindings[root.selected-index].allow-when-locked ? Theme.warning : Theme.text-muted;
                                    font-size: Theme.font-size-sm;
                                }
                            }

                            SettingRow {
                                label: "Repeat when held";
                                description: "Repeats the action while key is held";

                                Text {
                                    text: root.keybindings[root.selected-index].repeat ? "Yes" : "No";
                                    color: root.keybindings[root.selected-index].repeat ? Theme.info : Theme.text-muted;
                                    font-size: Theme.font-size-sm;
                                }
                            }

                            if root.keybindings[root.selected-index].has-cooldown: SettingRow {
                                label: "Cooldown";
                                description: "Minimum time between activations";

                                Text {
                                    text: root.keybindings[root.selected-index].cooldown-ms + " ms";
                                    color: Theme.text-secondary;
                                    font-size: Theme.font-size-sm;
                                }
                            }
                        }
                    }

                    // Spacer
                    Rectangle { height: Theme.spacing-lg; }
                }
            }

            // No selection message
            if !root.editor-visible && (root.selected-index < 0 || root.selected-index >= root.keybindings.length): Rectangle {
                background: Theme.card-background;
                border-radius: Theme.radius-md;

                VerticalLayout {
                    alignment: center;

                    Text {
                        text: "Select a keybinding to view or edit";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-md;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Double-click to edit";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-xs;
                        horizontal-alignment: center;
                    }
                }
            }
        }
    }
}
