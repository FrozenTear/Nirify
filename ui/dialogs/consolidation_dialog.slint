// Consolidation suggestions dialog - shown after import when similar rules are detected
import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { Theme } from "../styles.slint";

/// A single consolidation suggestion
export struct ConsolidationItem {
    /// Index in the suggestions list
    index: int,
    /// Human-readable description
    description: string,
    /// Number of rules that could be merged
    rule-count: int,
    /// Patterns that would be combined (e.g., "steam, lutris, heroic")
    patterns: string,
    /// The suggested merged regex
    merged-pattern: string,
    /// What settings these rules share
    shared-settings: string,
    /// Whether the user has selected this suggestion to apply
    selected: bool,
}

export component ConsolidationDialog inherits Rectangle {
    in property <bool> show-dialog: false;
    in property <[ConsolidationItem]> suggestions: [];
    in property <int> total-affected-rules: 0;

    callback dismissed();
    callback apply-selected();
    callback suggestion-toggled(int, bool);

    // Only render when visible
    visible: show-dialog;

    // Modal overlay
    background: Theme.overlay-background.with-alpha(0.82);

    // Consume clicks on overlay
    TouchArea {
        clicked => { dismissed(); }
    }

    // Dialog box
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: min(600px, parent.width - 40px);
        height: min(content.preferred-height + 2 * Theme.spacing-lg, parent.height - 80px);
        background: Theme.card-background;
        border-radius: Theme.radius-lg;
        drop-shadow-blur: 30px;
        drop-shadow-color: Theme.panel-shadow-color.with-alpha(0.38);

        // Prevent overlay click from dismissing
        TouchArea { }

        content := VerticalLayout {
            padding: Theme.spacing-lg;
            spacing: Theme.spacing-md;

            // Header
            HorizontalLayout {
                spacing: Theme.spacing-md;
                alignment: start;

                // Icon
                Rectangle {
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: Theme.info;

                    Text {
                        text: "?";
                        color: white;
                        font-size: 24px;
                        font-weight: 700;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                VerticalLayout {
                    spacing: Theme.spacing-xs;

                    Text {
                        text: "Consolidation Suggestions";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-xl;
                        font-weight: 600;
                    }

                    Text {
                        text: suggestions.length == 1
                            ? "Found 1 opportunity to simplify your rules"
                            : "Found " + suggestions.length + " opportunities to simplify your rules";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-md;
                    }
                }
            }

            // Explanation
            Rectangle {
                background: Theme.info.with-alpha(0.1);
                border-radius: Theme.radius-md;
                height: explanation-text.preferred-height + Theme.spacing-md;

                explanation-text := Text {
                    x: Theme.spacing-sm;
                    y: Theme.spacing-xs;
                    width: parent.width - 2 * Theme.spacing-sm;
                    text: "Multiple rules with identical settings can be merged into a single rule using regex patterns. This keeps your config cleaner and easier to maintain.";
                    color: Theme.text-secondary;
                    font-size: Theme.font-size-sm;
                    wrap: word-wrap;
                }
            }

            // Suggestions list
            Rectangle {
                vertical-stretch: 1;
                min-height: 150px;
                max-height: 300px;
                background: Theme.background;
                border-radius: Theme.radius-md;

                ScrollView {
                    viewport-height: suggestions-list.preferred-height;

                    suggestions-list := VerticalLayout {
                        padding: Theme.spacing-sm;
                        spacing: Theme.spacing-sm;

                        for suggestion[idx] in suggestions: Rectangle {
                            background: suggestion.selected
                                ? Theme.accent.with-alpha(0.15)
                                : Theme.surface-elevated;
                            border-radius: Theme.radius-md;
                            border-width: suggestion.selected ? 1px : 0px;
                            border-color: Theme.accent;
                            height: item-content.preferred-height + Theme.spacing-md;

                            TouchArea {
                                clicked => {
                                    suggestion-toggled(suggestion.index, !suggestion.selected);
                                }
                            }

                            item-content := HorizontalLayout {
                                padding: Theme.spacing-sm;
                                spacing: Theme.spacing-md;

                                // Checkbox
                                Rectangle {
                                    width: 24px;
                                    height: 24px;
                                    border-radius: Theme.radius-sm;
                                    background: suggestion.selected ? Theme.accent : Theme.control-background;
                                    border-width: suggestion.selected ? 0px : 1px;
                                    border-color: Theme.border;

                                    if suggestion.selected: Text {
                                        text: "+";
                                        color: Theme.accent-foreground;
                                        font-size: 16px;
                                        font-weight: 700;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }

                                // Details
                                VerticalLayout {
                                    horizontal-stretch: 1;
                                    spacing: Theme.spacing-xs;

                                    HorizontalLayout {
                                        spacing: Theme.spacing-sm;

                                        Text {
                                            text: suggestion.description;
                                            color: Theme.text-primary;
                                            font-size: Theme.font-size-md;
                                            font-weight: 500;
                                        }

                                        // Badge showing rule count
                                        Rectangle {
                                            width: count-text.preferred-width + Theme.spacing-sm;
                                            height: 20px;
                                            border-radius: 10px;
                                            background: Theme.accent.with-alpha(0.2);

                                            count-text := Text {
                                                text: suggestion.rule-count + " rules";
                                                color: Theme.accent;
                                                font-size: Theme.font-size-xs;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }

                                    Text {
                                        text: "Patterns: " + suggestion.patterns;
                                        color: Theme.text-secondary;
                                        font-size: Theme.font-size-sm;
                                        overflow: elide;
                                    }

                                    Text {
                                        text: "Settings: " + suggestion.shared-settings;
                                        color: Theme.text-muted;
                                        font-size: Theme.font-size-sm;
                                    }

                                    // Show merged pattern preview
                                    Rectangle {
                                        background: Theme.background;
                                        border-radius: Theme.radius-sm;
                                        height: merged-text.preferred-height + Theme.spacing-xs;

                                        merged-text := Text {
                                            x: Theme.spacing-xs;
                                            y: Theme.spacing-xs / 2;
                                            text: "Merged: " + suggestion.merged-pattern;
                                            color: Theme.success;
                                            font-size: Theme.font-size-xs;
                                            font-family: "monospace";
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Footer with buttons
            HorizontalLayout {
                spacing: Theme.spacing-md;

                Text {
                    text: "Select suggestions to apply, then click Apply";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-sm;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                Button {
                    text: "Skip";
                    clicked => { dismissed(); }
                }

                Button {
                    text: "Apply Selected";
                    enabled: suggestions.length > 0;
                    clicked => { apply-selected(); }
                }
            }
        }
    }
}
