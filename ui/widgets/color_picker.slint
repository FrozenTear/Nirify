import { Theme } from "../styles.slint";
import { LineEdit } from "std-widgets.slint";

// Color preset with hex value for proper sync
struct ColorPreset {
    color: color,
    hex: string,
}

// Common color presets (Material Design inspired + Catppuccin)
global ColorPresets {
    out property <[ColorPreset]> palette: [
        { color: #f44336, hex: "#f44336" },
        { color: #e91e63, hex: "#e91e63" },
        { color: #9c27b0, hex: "#9c27b0" },
        { color: #673ab7, hex: "#673ab7" },
        { color: #3f51b5, hex: "#3f51b5" },
        { color: #2196f3, hex: "#2196f3" },
        { color: #03a9f4, hex: "#03a9f4" },
        { color: #00bcd4, hex: "#00bcd4" },
        { color: #009688, hex: "#009688" },
        { color: #4caf50, hex: "#4caf50" },
        { color: #8bc34a, hex: "#8bc34a" },
        { color: #cddc39, hex: "#cddc39" },
        { color: #ffeb3b, hex: "#ffeb3b" },
        { color: #ffc107, hex: "#ffc107" },
        { color: #ff9800, hex: "#ff9800" },
        { color: #ff5722, hex: "#ff5722" },
        { color: #795548, hex: "#795548" },
        { color: #9e9e9e, hex: "#9e9e9e" },
        { color: #607d8b, hex: "#607d8b" },
        { color: #000000, hex: "#000000" },
        { color: #ffffff, hex: "#ffffff" },
        { color: #1e1e2e, hex: "#1e1e2e" },
        { color: #313244, hex: "#313244" },
        { color: #45475a, hex: "#45475a" },
    ];
}

// A color picker with preview, hex input, and expandable swatches
export component ColorPicker inherits Rectangle {
    in property <string> label;
    in property <string> description;
    in-out property <color> selected-color: #ffffff;
    in-out property <string> hex-value: "#ffffff";

    // Show/hide swatches
    property <bool> swatches-expanded: false;

    callback changed(color);

    // Note: Container has no accessible-role; the LineEdit inside handles accessibility

    // Prevent vertical stretching
    vertical-stretch: 0;

    min-height: swatches-expanded ? 88px : 44px;
    background: touch.has-hover || swatches-expanded ? Theme.surface-elevated.with-alpha(0.4) : transparent;
    border-radius: Theme.radius-md;
    border-width: touch.has-hover || swatches-expanded ? 1px : 0px;
    border-color: Theme.border.with-alpha(0.3);

    animate background { duration: Theme.duration-fast; easing: ease-out; }
    animate border-width { duration: Theme.duration-fast; easing: ease-out; }
    animate min-height { duration: 150ms; easing: ease-out; }

    touch := TouchArea {
        mouse-cursor: default;
    }

    VerticalLayout {
        spacing: Theme.spacing-xs;

        HorizontalLayout {
            padding-left: Theme.spacing-sm;
            padding-right: Theme.spacing-sm;
            spacing: Theme.spacing-md;

            // Label takes remaining space
            VerticalLayout {
                alignment: center;
                horizontal-stretch: 1;

                Text {
                    text: label;
                    color: Theme.text-primary;
                    font-size: Theme.font-size-md;
                }

                if description != "": Text {
                    text: description;
                    color: Theme.text-muted;
                    font-size: Theme.font-size-sm;
                    wrap: word-wrap;
                }
            }

            // Fixed-width control column
            Rectangle {
                width: Theme.control-column-width;
                background: transparent;

                HorizontalLayout {
                    alignment: end;
                    spacing: Theme.spacing-sm;

                    // Color preview swatch with ring - click to toggle swatches
                    Rectangle {
                        width: Theme.color-swatch-size + 4px;
                        height: Theme.color-swatch-size + 4px;
                        background: transparent;
                        border-radius: Theme.radius-md;
                        border-width: 2px;
                        border-color: root.selected-color.with-alpha(0.5);

                        Rectangle {
                            x: 2px;
                            y: 2px;
                            width: Theme.color-swatch-size;
                            height: Theme.color-swatch-size;
                            background: root.selected-color;
                            border-radius: Theme.radius-sm;
                        }

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                root.swatches-expanded = !root.swatches-expanded;
                            }
                        }
                    }

                    // Hex input field - use one-way binding to prevent update loops
                    LineEdit {
                        width: Theme.color-input-width;
                        text: root.hex-value;
                        font-size: Theme.font-size-sm;
                        horizontal-alignment: center;

                        accessible-label: root.label + " hex color value";
                        accessible-description: "Enter color in hex format like #ff0000";

                        edited(new-text) => {
                            // Update hex-value and notify on valid-looking hex input
                            // Using one-way binding + explicit update prevents binding loops
                            root.hex-value = new-text;
                            if (new-text.character-count == 7 || new-text.character-count == 4) {
                                root.changed(root.selected-color);
                            }
                        }

                        accepted => {
                            root.changed(root.selected-color);
                        }
                    }
                }
            }
        }

        // Expandable swatches row
        if swatches-expanded: Rectangle {
            height: 36px;
            background: transparent;

            HorizontalLayout {
                padding-left: Theme.spacing-sm;
                padding-right: Theme.spacing-sm;
                spacing: 4px;
                alignment: start;

                for preset in ColorPresets.palette: Rectangle {
                    width: 24px;
                    height: 24px;
                    background: preset.color;
                    border-radius: 4px;
                    border-width: swatch-touch.has-hover ? 2px : 1px;
                    border-color: swatch-touch.has-hover ? Theme.accent : Theme.border.with-alpha(0.5);

                    swatch-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            root.selected-color = preset.color;
                            root.hex-value = preset.hex;
                            root.changed(preset.color);
                            root.swatches-expanded = false;
                        }
                    }

                    animate border-width { duration: 100ms; }
                    animate border-color { duration: 100ms; }
                }
            }
        }
    }
}

// Preset color swatches for quick selection
export component ColorSwatches inherits Rectangle {
    in property <[color]> colors: [
        #f44336, #e91e63, #9c27b0, #673ab7,
        #3f51b5, #2196f3, #03a9f4, #00bcd4,
        #009688, #4caf50, #8bc34a, #cddc39,
        #ffeb3b, #ffc107, #ff9800, #ff5722
    ];

    // Track which swatch is focused for keyboard navigation
    property <int> focused-index: -1;

    callback selected(color);

    // Accessibility
    accessible-role: list;
    accessible-label: "Color swatches - use arrow keys to navigate, Space or Enter to select";

    height: 40px;
    background: transparent;

    // Main focus scope for arrow key navigation
    main-focus := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.RightArrow) {
                if (root.focused-index < root.colors.length - 1) {
                    root.focused-index = root.focused-index + 1;
                }
                accept
            } else if (event.text == Key.LeftArrow) {
                if (root.focused-index > 0) {
                    root.focused-index = root.focused-index - 1;
                }
                accept
            } else if (event.text == Key.Home) {
                root.focused-index = 0;
                accept
            } else if (event.text == Key.End) {
                root.focused-index = root.colors.length - 1;
                accept
            } else if ((event.text == " " || event.text == "\n") && root.focused-index >= 0) {
                root.selected(root.colors[root.focused-index]);
                accept
            }
            reject
        }

        focus-changed-event => {
            // When focus scope gains focus, ensure an item is selected
            if (self.has-focus && root.focused-index < 0) {
                root.focused-index = 0;
            }
        }
    }

    HorizontalLayout {
        spacing: Theme.spacing-xs;
        alignment: center;

        for col[index] in colors: Rectangle {
            width: Theme.color-swatch-small;
            height: Theme.color-swatch-small;
            background: col;
            border-radius: Theme.radius-sm;
            border-width: touch.has-hover || (main-focus.has-focus && root.focused-index == index) ? 2px : 1px;
            border-color: touch.has-hover || (main-focus.has-focus && root.focused-index == index) ? Theme.accent : Theme.border;

            // Accessibility for each swatch - include position for screen readers
            accessible-role: button;
            accessible-label: "Color preset " + (index + 1);

            touch := TouchArea {
                clicked => {
                    main-focus.focus();
                    root.focused-index = index;
                    root.selected(col);
                }
            }

            animate border-width { duration: 100ms; easing: ease-in-out; }
            animate border-color { duration: 100ms; easing: ease-in-out; }
        }
    }
}
