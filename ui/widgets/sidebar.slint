import { Theme } from "../styles.slint";

// Sidebar category indices - centralized to avoid magic numbers
//
// IMPORTANT: These indices must be kept in sync with:
// 1. The sidebar UI items in this file (SidebarContent component)
// 2. The page rendering logic in main.slint (if page-index == X)
//
// When adding a new page:
// 1. Add a new property here with the next available index
// 2. Add the sidebar item in SidebarContent below
// 3. Add the page rendering condition in main.slint
export global SidebarIndices {
    // Top-level items
    out property <int> appearance: 0;
    out property <int> behavior: 1;

    // Input group
    out property <int> keyboard: 2;
    out property <int> mouse: 3;
    out property <int> touchpad: 4;
    out property <int> trackpoint: 16;
    out property <int> trackball: 17;
    out property <int> tablet: 18;
    out property <int> touch: 19;

    // Displays (standalone)
    out property <int> displays: 5;

    // Visuals group
    out property <int> animations: 6;
    out property <int> cursor: 7;
    out property <int> overview: 8;

    // Advanced group
    out property <int> layout-extras: 9;
    out property <int> gestures: 10;
    out property <int> miscellaneous: 11;
    out property <int> window-rules: 12;
    out property <int> workspaces: 14;
    out property <int> layer-rules: 15;
    out property <int> keybindings: 20;
    out property <int> startup: 21;
    out property <int> environment: 22;
    out property <int> debug: 23;
    out property <int> switch-events: 24;
    out property <int> recent-windows: 25;
    out property <int> tools: 26;
    out property <int> config-editor: 27;
    out property <int> backups: 28;
}

// Sidebar navigation item with category accent support
export component SidebarItem inherits Rectangle {
    in property <string> label;
    in property <bool> selected: false;
    in property <bool> is-separator: false;
    in property <bool> is-nested: false;  // For items inside a group
    in property <color> accent-color: Theme.accent;  // Category accent

    callback clicked();

    // Accessibility (role must be constant, so button for all)
    accessible-role: button;
    accessible-label: is-separator ? "separator" : label;
    accessible-checkable: true;
    accessible-checked: selected;

    height: is-separator ? 1px : Theme.control-height;
    background: is-separator ? Theme.border :
                selected ? accent-color.with-alpha(0.15) :
                ta.has-hover ? Theme.surface-elevated : transparent;
    border-radius: is-separator ? 0px : Theme.radius-md;
    // Keyboard focus indicator
    border-width: focus-scope.has-focus && !is-separator ? 2px : 0px;
    border-color: accent-color;

    // Left accent indicator for selected state
    if selected && !is-separator: Rectangle {
        x: 0;
        y: (parent.height - 20px) / 2;
        width: 3px;
        height: 20px;
        background: accent-color;
        border-radius: 1.5px;
    }

    if !is-separator: HorizontalLayout {
        padding-left: is-nested ? Theme.spacing-xl : Theme.spacing-md;
        padding-right: Theme.spacing-md;

        Text {
            text: label;
            color: selected ? accent-color : ta.has-hover ? Theme.text-primary : Theme.text-secondary;
            font-size: Theme.font-size-md;
            font-weight: selected ? 500 : 400;
            vertical-alignment: center;
            // Text is part of button - accessibility handled by parent
            accessible-role: none;
        }
    }

    focus-scope := FocusScope {
        enabled: !is-separator;
        key-pressed(event) => {
            if (event.text == " " || event.text == "\n") {
                root.clicked();
                accept
            }
            reject
        }
    }

    ta := TouchArea {
        enabled: !is-separator;
        mouse-cursor: pointer;
        clicked => {
            focus-scope.focus();
            root.clicked();
        }
    }

    animate background { duration: Theme.duration-normal; easing: ease-in-out; }
    animate border-width { duration: Theme.duration-fast; easing: ease-in-out; }
}

// Collapsible section header (legacy - kept for compatibility)
export component SidebarSection inherits Rectangle {
    in property <string> label;
    in-out property <bool> expanded: false;

    callback clicked();

    // Accessibility
    accessible-role: button;
    accessible-label: expanded ? "Collapse " + label : "Expand " + label;
    accessible-expanded: expanded;

    height: Theme.section-header-height;
    background: transparent;

    HorizontalLayout {
        padding-left: Theme.spacing-md;
        padding-right: Theme.spacing-md;

        Text {
            text: expanded ? "▾" : "▸";
            color: Theme.text-secondary;
            font-size: Theme.font-size-sm;
            width: Theme.icon-size-sm;
            vertical-alignment: center;
            // Decorative arrow icon
            accessible-role: none;
        }

        Text {
            text: label;
            color: Theme.text-secondary;
            font-size: Theme.font-size-md;
            vertical-alignment: center;
            // Text is part of button - accessibility handled by parent
            accessible-role: none;
        }
    }

    TouchArea {
        clicked => {
            expanded = !expanded;
            root.clicked();
        }
    }
}

// Collapsible group header for sidebar navigation
export component SidebarGroupHeader inherits Rectangle {
    in property <string> label;
    in-out property <bool> expanded: true;
    in property <bool> has-selected-child: false;  // Highlight if child is selected
    in property <color> accent-color: Theme.accent;  // Category accent

    callback toggle-expanded();

    // Accessibility
    accessible-role: button;
    accessible-label: expanded ? "Collapse " + label : "Expand " + label;
    accessible-expanded: expanded;

    height: Theme.control-height;
    background: ta.has-hover ? Theme.surface-elevated : transparent;
    border-radius: Theme.radius-md;
    border-width: focus-scope.has-focus ? 2px : 0px;
    border-color: accent-color;

    HorizontalLayout {
        padding-left: Theme.spacing-md;
        padding-right: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        // Category accent dot
        Rectangle {
            width: 8px;
            height: 8px;
            y: (parent.height - self.height) / 2;
            background: has-selected-child ? accent-color : accent-color.with-alpha(0.4);
            border-radius: 4px;
        }

        Text {
            text: label;
            color: has-selected-child ? accent-color : Theme.text-primary;
            font-size: Theme.font-size-md;
            font-weight: 600;
            letter-spacing: 0.5px;
            vertical-alignment: center;
            horizontal-stretch: 1;
            accessible-role: none;
        }

        Text {
            text: expanded ? "−" : "+";
            color: Theme.text-muted;
            font-size: Theme.font-size-md;
            vertical-alignment: center;
            accessible-role: none;
        }
    }

    focus-scope := FocusScope {
        key-pressed(event) => {
            if (event.text == " " || event.text == "\n") {
                root.expanded = !root.expanded;
                root.toggle-expanded();
                accept
            }
            reject
        }
    }

    ta := TouchArea {
        mouse-cursor: pointer;
        clicked => {
            focus-scope.focus();
            root.expanded = !root.expanded;
            root.toggle-expanded();
        }
    }

    animate background { duration: Theme.duration-normal; easing: ease-in-out; }
}

// Main sidebar component with category-coded accent colors
export component Sidebar inherits Rectangle {
    in-out property <int> selected-index: 0;

    // Group expansion states
    in-out property <bool> input-expanded: true;
    in-out property <bool> visuals-expanded: true;
    in-out property <bool> advanced-expanded: false;
    in-out property <bool> developer-expanded: false;

    // Debug options visibility (hidden by default)
    in-out property <bool> show-debug-options: false;

    callback category-selected(int);

    // Computed properties for group selection state
    property <bool> input-has-selection:
        selected-index == SidebarIndices.keyboard || selected-index == SidebarIndices.mouse ||
        selected-index == SidebarIndices.touchpad || selected-index == SidebarIndices.trackpoint ||
        selected-index == SidebarIndices.trackball || selected-index == SidebarIndices.tablet ||
        selected-index == SidebarIndices.touch;

    property <bool> visuals-has-selection:
        selected-index == SidebarIndices.animations || selected-index == SidebarIndices.cursor ||
        selected-index == SidebarIndices.overview;

    property <bool> advanced-has-selection:
        selected-index == SidebarIndices.layout-extras || selected-index == SidebarIndices.gestures ||
        selected-index == SidebarIndices.miscellaneous || selected-index == SidebarIndices.window-rules ||
        selected-index == SidebarIndices.workspaces || selected-index == SidebarIndices.layer-rules ||
        selected-index == SidebarIndices.keybindings || selected-index == SidebarIndices.startup ||
        selected-index == SidebarIndices.environment || selected-index == SidebarIndices.recent-windows;

    property <bool> developer-has-selection:
        selected-index == SidebarIndices.debug ||
        selected-index == SidebarIndices.switch-events ||
        selected-index == SidebarIndices.tools ||
        selected-index == SidebarIndices.config-editor ||
        selected-index == SidebarIndices.backups;

    width: Theme.sidebar-width;
    background: Theme.sidebar-background;

    VerticalLayout {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-xs;

        // Top-level items (Visual category)
        SidebarItem {
            label: "Appearance";
            selected: selected-index == SidebarIndices.appearance;
            accent-color: Theme.accent-visual;
            clicked => {
                selected-index = SidebarIndices.appearance;
                category-selected(SidebarIndices.appearance);
            }
        }
        SidebarItem {
            label: "Behavior";
            selected: selected-index == SidebarIndices.behavior;
            accent-color: Theme.accent-layout;
            clicked => {
                selected-index = SidebarIndices.behavior;
                category-selected(SidebarIndices.behavior);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // INPUT GROUP - Cyan accent
        // ═══════════════════════════════════════════════════════════════
        SidebarGroupHeader {
            label: "Input";
            expanded <=> input-expanded;
            has-selected-child: input-has-selection;
            accent-color: Theme.accent-input;
        }

        if input-expanded: SidebarItem {
            label: "Keyboard";
            selected: selected-index == SidebarIndices.keyboard;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.keyboard;
                category-selected(SidebarIndices.keyboard);
            }
        }
        if input-expanded: SidebarItem {
            label: "Mouse";
            selected: selected-index == SidebarIndices.mouse;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.mouse;
                category-selected(SidebarIndices.mouse);
            }
        }
        if input-expanded: SidebarItem {
            label: "Touchpad";
            selected: selected-index == SidebarIndices.touchpad;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.touchpad;
                category-selected(SidebarIndices.touchpad);
            }
        }
        if input-expanded: SidebarItem {
            label: "Trackpoint";
            selected: selected-index == SidebarIndices.trackpoint;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.trackpoint;
                category-selected(SidebarIndices.trackpoint);
            }
        }
        if input-expanded: SidebarItem {
            label: "Trackball";
            selected: selected-index == SidebarIndices.trackball;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.trackball;
                category-selected(SidebarIndices.trackball);
            }
        }
        if input-expanded: SidebarItem {
            label: "Tablet";
            selected: selected-index == SidebarIndices.tablet;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.tablet;
                category-selected(SidebarIndices.tablet);
            }
        }
        if input-expanded: SidebarItem {
            label: "Touch";
            selected: selected-index == SidebarIndices.touch;
            is-nested: true;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.touch;
                category-selected(SidebarIndices.touch);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // DISPLAYS (standalone - hardware, uses input accent)
        // ═══════════════════════════════════════════════════════════════
        SidebarItem {
            label: "Displays";
            selected: selected-index == SidebarIndices.displays;
            accent-color: Theme.accent-input;
            clicked => {
                selected-index = SidebarIndices.displays;
                category-selected(SidebarIndices.displays);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // VISUALS GROUP - Purple accent
        // ═══════════════════════════════════════════════════════════════
        SidebarGroupHeader {
            label: "Visuals";
            expanded <=> visuals-expanded;
            has-selected-child: visuals-has-selection;
            accent-color: Theme.accent-visual;
        }

        if visuals-expanded: SidebarItem {
            label: "Animations";
            selected: selected-index == SidebarIndices.animations;
            is-nested: true;
            accent-color: Theme.accent-visual;
            clicked => {
                selected-index = SidebarIndices.animations;
                category-selected(SidebarIndices.animations);
            }
        }
        if visuals-expanded: SidebarItem {
            label: "Cursor";
            selected: selected-index == SidebarIndices.cursor;
            is-nested: true;
            accent-color: Theme.accent-visual;
            clicked => {
                selected-index = SidebarIndices.cursor;
                category-selected(SidebarIndices.cursor);
            }
        }
        if visuals-expanded: SidebarItem {
            label: "Overview";
            selected: selected-index == SidebarIndices.overview;
            is-nested: true;
            accent-color: Theme.accent-visual;
            clicked => {
                selected-index = SidebarIndices.overview;
                category-selected(SidebarIndices.overview);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // ADVANCED GROUP - Mixed accents by sub-category
        // ═══════════════════════════════════════════════════════════════
        SidebarGroupHeader {
            label: "Advanced";
            expanded <=> advanced-expanded;
            has-selected-child: advanced-has-selection;
            accent-color: Theme.accent-system;
        }

        // Layout sub-category (golden)
        if advanced-expanded: SidebarItem {
            label: "Layout Extras";
            selected: selected-index == SidebarIndices.layout-extras;
            is-nested: true;
            accent-color: Theme.accent-layout;
            clicked => {
                selected-index = SidebarIndices.layout-extras;
                category-selected(SidebarIndices.layout-extras);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Workspaces";
            selected: selected-index == SidebarIndices.workspaces;
            is-nested: true;
            accent-color: Theme.accent-layout;
            clicked => {
                selected-index = SidebarIndices.workspaces;
                category-selected(SidebarIndices.workspaces);
            }
        }

        // Rules sub-category (rose)
        if advanced-expanded: SidebarItem {
            label: "Window Rules";
            selected: selected-index == SidebarIndices.window-rules;
            is-nested: true;
            accent-color: Theme.accent-rules;
            clicked => {
                selected-index = SidebarIndices.window-rules;
                category-selected(SidebarIndices.window-rules);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Layer Rules";
            selected: selected-index == SidebarIndices.layer-rules;
            is-nested: true;
            accent-color: Theme.accent-rules;
            clicked => {
                selected-index = SidebarIndices.layer-rules;
                category-selected(SidebarIndices.layer-rules);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Gestures";
            selected: selected-index == SidebarIndices.gestures;
            is-nested: true;
            accent-color: Theme.accent-rules;
            clicked => {
                selected-index = SidebarIndices.gestures;
                category-selected(SidebarIndices.gestures);
            }
        }

        // System sub-category (mint)
        if advanced-expanded: SidebarItem {
            label: "Keybindings";
            selected: selected-index == SidebarIndices.keybindings;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.keybindings;
                category-selected(SidebarIndices.keybindings);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Startup";
            selected: selected-index == SidebarIndices.startup;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.startup;
                category-selected(SidebarIndices.startup);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Environment";
            selected: selected-index == SidebarIndices.environment;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.environment;
                category-selected(SidebarIndices.environment);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Recent Windows";
            selected: selected-index == SidebarIndices.recent-windows;
            is-nested: true;
            accent-color: Theme.accent-visual;
            clicked => {
                selected-index = SidebarIndices.recent-windows;
                category-selected(SidebarIndices.recent-windows);
            }
        }
        if advanced-expanded: SidebarItem {
            label: "Miscellaneous";
            selected: selected-index == SidebarIndices.miscellaneous;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.miscellaneous;
                category-selected(SidebarIndices.miscellaneous);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // DEVELOPER GROUP - System accent (collapsed by default)
        // ═══════════════════════════════════════════════════════════════
        SidebarGroupHeader {
            label: "Developer";
            expanded <=> developer-expanded;
            has-selected-child: developer-has-selection;
            accent-color: Theme.accent-system;
        }

        if developer-expanded && show-debug-options: SidebarItem {
            label: "Debug";
            selected: selected-index == SidebarIndices.debug;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.debug;
                category-selected(SidebarIndices.debug);
            }
        }
        if developer-expanded: SidebarItem {
            label: "Switch Events";
            selected: selected-index == SidebarIndices.switch-events;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.switch-events;
                category-selected(SidebarIndices.switch-events);
            }
        }
        if developer-expanded: SidebarItem {
            label: "Tools";
            selected: selected-index == SidebarIndices.tools;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.tools;
                category-selected(SidebarIndices.tools);
            }
        }
        if developer-expanded: SidebarItem {
            label: "Config Viewer";
            selected: selected-index == SidebarIndices.config-editor;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.config-editor;
                category-selected(SidebarIndices.config-editor);
            }
        }
        if developer-expanded: SidebarItem {
            label: "Backups";
            selected: selected-index == SidebarIndices.backups;
            is-nested: true;
            accent-color: Theme.accent-system;
            clicked => {
                selected-index = SidebarIndices.backups;
                category-selected(SidebarIndices.backups);
            }
        }

        // Spacer
        Rectangle { vertical-stretch: 1; }
    }
}
