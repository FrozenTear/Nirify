// Widget for entering a 6-value calibration matrix for libinput devices
// The matrix represents a 2x3 transformation matrix used for touchscreens and tablets

import { Theme } from "../styles.slint";
import { LineEdit } from "std-widgets.slint";

export component CalibrationMatrixRow inherits Rectangle {
    in property <string> label: "Calibration Matrix";
    in property <string> description: "6 values for libinput transformation matrix";
    in-out property <bool> has-matrix: false;
    in-out property <float> m0: 1.0;
    in-out property <float> m1: 0.0;
    in-out property <float> m2: 0.0;
    in-out property <float> m3: 0.0;
    in-out property <float> m4: 1.0;
    in-out property <float> m5: 0.0;

    callback toggled(bool);
    callback matrix-changed(float, float, float, float, float, float);

    background: transparent;
    min-height: has-matrix ? 120px : Theme.control-height;

    accessible-role: none;

    VerticalLayout {
        spacing: Theme.spacing-xs;

        HorizontalLayout {
            spacing: Theme.spacing-md;

            // Toggle checkbox
            Rectangle {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                border-width: 2px;
                border-color: has-matrix ? Theme.accent : Theme.border;
                background: has-matrix ? Theme.accent : transparent;

                accessible-role: checkbox;
                accessible-label: "Enable " + label;
                accessible-checked: has-matrix;

                if has-matrix: Text {
                    text: "âœ“";
                    color: Theme.text-primary;
                    font-size: 12px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                TouchArea {
                    clicked => {
                        has-matrix = !has-matrix;
                        toggled(has-matrix);
                    }
                }
            }

            // Labels
            VerticalLayout {
                spacing: 2px;
                horizontal-stretch: 1;

                Text {
                    text: label;
                    color: Theme.text-primary;
                    font-size: Theme.font-size-md;
                    accessible-role: none;
                }
                Text {
                    text: description;
                    color: Theme.text-secondary;
                    font-size: Theme.font-size-sm;
                    accessible-role: none;
                }
            }
        }

        // Matrix input fields (shown when enabled)
        if has-matrix: Rectangle {
            background: Theme.surface-elevated;
            border-radius: Theme.radius-sm;
            height: 80px;

            VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-xs;

                // Row labels
                HorizontalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "Row 1:";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-sm;
                        width: 50px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text: "\{root.m0}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [0,0]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m0 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }

                    LineEdit {
                        text: "\{root.m1}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [0,1]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m1 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }

                    LineEdit {
                        text: "\{root.m2}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [0,2]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m2 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "Row 2:";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-sm;
                        width: 50px;
                        vertical-alignment: center;
                    }

                    LineEdit {
                        text: "\{root.m3}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [1,0]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m3 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }

                    LineEdit {
                        text: "\{root.m4}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [1,1]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m4 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }

                    LineEdit {
                        text: "\{root.m5}";
                        horizontal-stretch: 1;
                        accessible-label: "Matrix value [1,2]";
                        edited(val) => {
                            if (val.to-float() >= -10.0 && val.to-float() <= 10.0) {
                                root.m5 = val.to-float();
                                root.matrix-changed(m0, m1, m2, m3, m4, m5);
                            }
                        }
                    }
                }
            }
        }
    }
}
