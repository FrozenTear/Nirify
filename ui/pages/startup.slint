// Dynamic Startup Commands settings page
// Uses model-driven rendering for reduced compile time

import { Theme } from "../styles.slint";
import { ScrollView, LineEdit, Button } from "std-widgets.slint";

// Main page component
export component StartupDynamicPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Startup commands settings";

    // Command list (display strings like "waybar" or "bash -c ...")
    in-out property <[string]> command-list: [];
    in-out property <int> selected-index: -1;

    // Current command being edited (the full command string)
    in-out property <string> current-command: "";

    // Callbacks
    callback command-add();
    callback command-remove(int);
    callback command-select(int);
    callback command-changed(string);
    callback reorder-command(int, int);  // from-index, to-index

    background: transparent;

    // Keyboard focus index
    property <int> focused-command-index: -1;

    // Drag-and-drop state
    property <bool> is-dragging: false;
    property <int> drag-from-index: -1;
    property <int> drag-target-index: -1;
    property <length> drag-current-y: 0;
    property <length> item-height: 40px;

    HorizontalLayout {
        spacing: Theme.spacing-md;

        // Commands list panel
        Rectangle {
            width: Theme.panel-width-narrow;
            background: Theme.card-background;
            border-radius: Theme.radius-md;

            VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-sm;

                // Header
                HorizontalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "Startup Commands";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-md;
                        font-weight: 600;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: "+";
                        accessible-label: "Add new startup command";
                        clicked => { root.command-add(); }
                    }
                }

                // Description
                Text {
                    text: "Commands that run when niri starts";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-sm;
                    wrap: word-wrap;
                }

                // Commands list with keyboard navigation
                commands-focus := FocusScope {
                    vertical-stretch: 1;

                    accessible-role: list;
                    accessible-label: "Startup commands list";

                    key-pressed(event) => {
                        if (event.text == Key.DownArrow) {
                            if (root.focused-command-index < root.command-list.length - 1) {
                                root.focused-command-index = root.focused-command-index + 1;
                            }
                            accept
                        } else if (event.text == Key.UpArrow) {
                            if (root.focused-command-index > 0) {
                                root.focused-command-index = root.focused-command-index - 1;
                            } else if (root.focused-command-index == -1 && root.command-list.length > 0) {
                                root.focused-command-index = 0;
                            }
                            accept
                        } else if (event.text == Key.Return || event.text == " ") {
                            if (root.focused-command-index >= 0) {
                                root.selected-index = root.focused-command-index;
                                root.command-select(root.focused-command-index);
                            }
                            accept
                        } else if (event.text == Key.Delete) {
                            if (root.focused-command-index >= 0 && root.focused-command-index == root.selected-index) {
                                root.command-remove(root.focused-command-index);
                            }
                            accept
                        }
                        reject
                    }

                    focus-changed-event => {
                        if (self.has-focus && root.focused-command-index == -1 && root.command-list.length > 0) {
                            root.focused-command-index = root.selected-index >= 0 ? root.selected-index : 0;
                        }
                    }

                    ScrollView {
                        list-container := VerticalLayout {
                            spacing: Theme.spacing-xs;

                            for cmd[index] in root.command-list : VerticalLayout {
                                spacing: 0;

                                // Drop indicator - shows above this item when dragging
                                Rectangle {
                                    height: root.is-dragging && root.drag-target-index == index ? 3px : 0;
                                    background: Theme.accent;
                                    border-radius: 1.5px;
                                }

                                Rectangle {
                                    height: root.item-height;
                                    background: root.is-dragging && root.drag-from-index == index
                                        ? Theme.card-background.with-alpha(0.3)
                                        : index == root.selected-index
                                            ? Theme.accent.with-alpha(0.2)
                                            : transparent;
                                    border-radius: Theme.radius-sm;
                                    border-width: index == root.focused-command-index && commands-focus.has-focus ? 2px : 0px;
                                    border-color: Theme.accent;
                                    opacity: root.is-dragging && root.drag-from-index == index ? 0.5 : 1.0;

                                    accessible-role: list-item;
                                    accessible-label: cmd;

                                    touch := TouchArea {
                                        property <length> press-start-y: 0;
                                        property <bool> drag-started: false;

                                        pointer-event(event) => {
                                            if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                                                self.press-start-y = self.mouse-y;
                                                self.drag-started = false;
                                            } else if (event.kind == PointerEventKind.up || event.kind == PointerEventKind.cancel) {
                                                if (root.is-dragging) {
                                                    // Complete the drag
                                                    if (root.drag-target-index >= 0 && root.drag-target-index != root.drag-from-index) {
                                                        root.reorder-command(root.drag-from-index, root.drag-target-index);
                                                    }
                                                    root.is-dragging = false;
                                                    root.drag-from-index = -1;
                                                    root.drag-target-index = -1;
                                                } else if (!self.drag-started) {
                                                    // Normal click - select item
                                                    root.focused-command-index = index;
                                                    root.selected-index = index;
                                                    root.command-select(index);
                                                    commands-focus.focus();
                                                }
                                                self.drag-started = false;
                                            }
                                        }

                                        moved => {
                                            if (self.pressed) {
                                                // Check drag threshold (5px)
                                                if (!self.drag-started && abs(self.mouse-y - self.press-start-y) > 5px) {
                                                    self.drag-started = true;
                                                    root.is-dragging = true;
                                                    root.drag-from-index = index;
                                                }

                                                if (root.is-dragging) {
                                                    // Update drag position for ghost
                                                    root.drag-current-y = self.mouse-y + index * (root.item-height + Theme.spacing-xs);

                                                    // Calculate target index based on Y position
                                                    // Each item slot is item-height + spacing-xs
                                                    root.drag-target-index = clamp(
                                                        round(root.drag-current-y / (root.item-height + Theme.spacing-xs)),
                                                        0,
                                                        root.command-list.length
                                                    );
                                                }
                                            }
                                        }
                                    }

                                    HorizontalLayout {
                                        padding-left: Theme.spacing-sm;
                                        padding-right: Theme.spacing-sm;

                                        Text {
                                            text: cmd;
                                            color: index == root.selected-index ? Theme.accent : Theme.text-primary;
                                            font-size: Theme.font-size-sm;
                                            vertical-alignment: center;
                                            horizontal-stretch: 1;
                                            overflow: elide;
                                        }

                                        Button {
                                            visible: index == root.selected-index && !root.is-dragging;
                                            text: "x";
                                            accessible-label: "Remove command";
                                            clicked => { root.command-remove(index); }
                                        }
                                    }
                                }
                            }

                            // Drop indicator at end of list
                            Rectangle {
                                height: root.is-dragging && root.drag-target-index == root.command-list.length ? 3px : 0;
                                background: Theme.accent;
                                border-radius: 1.5px;
                            }

                            if root.command-list.length == 0: Text {
                                text: "No startup commands.\nClick + to add one.";
                                color: Theme.text-muted;
                                font-size: Theme.font-size-sm;
                                horizontal-alignment: center;
                            }
                        }

                        // Ghost item while dragging
                        if root.is-dragging && root.drag-from-index >= 0 && root.drag-from-index < root.command-list.length: Rectangle {
                            x: Theme.spacing-sm;
                            y: root.drag-current-y - root.item-height / 2;
                            width: list-container.width - Theme.spacing-md;
                            height: root.item-height;
                            background: Theme.card-background;
                            border-radius: Theme.radius-sm;
                            border-width: 2px;
                            border-color: Theme.accent;
                            opacity: 0.9;

                            HorizontalLayout {
                                padding-left: Theme.spacing-sm;
                                padding-right: Theme.spacing-sm;

                                Text {
                                    text: root.command-list[root.drag-from-index];
                                    color: Theme.accent;
                                    font-size: Theme.font-size-sm;
                                    vertical-alignment: center;
                                    overflow: elide;
                                }
                            }
                        }
                    }
                }
            }
        }

        // Command editor panel
        if root.selected-index >= 0: Rectangle {
            horizontal-stretch: 1;
            background: Theme.card-background;
            border-radius: Theme.radius-md;

            ScrollView {
                VerticalLayout {
                    alignment: start;
                    spacing: Theme.spacing-lg;
                    padding: Theme.spacing-md;

                    // Section header
                    Text {
                        text: "COMMAND";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-xs;
                        font-weight: 600;
                        letter-spacing: 0.5px;
                    }

                    VerticalLayout {
                        spacing: Theme.spacing-sm;

                        // Command input row
                        HorizontalLayout {
                            spacing: Theme.spacing-md;

                            VerticalLayout {
                                horizontal-stretch: 1;
                                spacing: 2px;
                                alignment: center;

                                Text {
                                    text: "Command";
                                    color: Theme.text-primary;
                                    font-size: Theme.font-size-sm;
                                    font-weight: 500;
                                }

                                Text {
                                    text: "The command to run at startup (e.g., waybar, swww-daemon)";
                                    color: Theme.text-muted;
                                    font-size: Theme.font-size-xs;
                                    wrap: word-wrap;
                                }
                            }

                            LineEdit {
                                width: 300px;
                                text: root.current-command;
                                placeholder-text: "e.g., waybar";
                                edited(value) => {
                                    root.current-command = value;
                                    root.command-changed(value);
                                }
                            }
                        }

                        Text {
                            text: "Tip: For commands with arguments, enter the full command.\nExample: bash -c \"sleep 1 && waybar\"";
                            color: Theme.text-muted;
                            font-size: Theme.font-size-sm;
                            wrap: word-wrap;
                        }
                    }

                    // Spacer at bottom
                    Rectangle { height: Theme.spacing-lg; }
                }
            }
        }

        // No selection message
        if root.selected-index < 0: Rectangle {
            horizontal-stretch: 1;
            background: Theme.card-background;
            border-radius: Theme.radius-md;

            VerticalLayout {
                alignment: center;

                Text {
                    text: "Select a command to edit";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-md;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Or click + to add a new startup command";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-sm;
                    horizontal-alignment: center;
                }
            }
        }
    }
}
