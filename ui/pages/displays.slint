import { Theme } from "../styles.slint";
import { ScrollView, LineEdit, Button, ComboBox } from "std-widgets.slint";
import { SettingsSection, SettingRow } from "../widgets/section.slint";
import { ToggleRow } from "../widgets/toggle_row.slint";
import { SliderRow } from "../widgets/slider_row.slint";
import { ComboBoxRow } from "../widgets/combobox_row.slint";
import { PercentageSliderRow } from "../widgets/percentage_slider_row.slint";
import { ConfirmDialog } from "../dialogs/confirm_dialog.slint";

// Displays/Outputs settings page for niri
export component DisplaysPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Display settings";

    // Expert mode - gates dangerous settings (from Debug page)
    in property <bool> expert-mode: false;

    // Current outputs list (as model array for proper selection)
    in-out property <[string]> output-list: [];
    in-out property <int> selected-output-index: -1;
    // Keep string version for backward compat
    in-out property <string> output-names: "";

    // Discovered outputs from niri
    in-out property <[string]> discovered-outputs: [];

    // Selected output settings
    in-out property <string> current-output-name: "";
    in-out property <bool> current-output-enabled: true;
    in-out property <float> current-output-scale: 1.0;
    in-out property <string> current-output-mode: "";
    in-out property <int> current-output-pos-x: 0;
    in-out property <int> current-output-pos-y: 0;
    in-out property <int> current-output-transform-index: 0;  // 0=Normal, 1=90, 2=180, 3=270, 4=Flipped, etc.
    in-out property <int> current-output-vrr-index: 0;  // 0=Off, 1=On, 2=OnDemand

    // Available modes for selected output (from niri IPC)
    in-out property <[string]> available-modes: [];
    in-out property <int> selected-mode-index: -1;
    in-out property <bool> use-custom-mode: false;  // User wants to type custom mode

    // Phase 8: Custom mode/modeline
    in-out property <bool> current-output-mode-custom: false;
    in-out property <string> current-output-modeline: "";

    // Phase 8: Per-output hot corners
    in-out property <bool> current-output-hot-corners-enabled: false;
    in-out property <bool> current-output-hc-override-enabled: false;  // Has custom hot corners set
    in-out property <bool> current-output-hc-top-left: false;
    in-out property <bool> current-output-hc-top-right: false;
    in-out property <bool> current-output-hc-bottom-left: false;
    in-out property <bool> current-output-hc-bottom-right: false;

    // Phase 8: Per-output layout override
    in-out property <bool> current-output-layout-override-enabled: false;
    in-out property <float> current-output-layout-gaps-inner: 8;
    in-out property <float> current-output-layout-gaps-outer: 8;
    in-out property <float> current-output-layout-struts-left: 0;
    in-out property <float> current-output-layout-struts-right: 0;
    in-out property <float> current-output-layout-struts-top: 0;
    in-out property <float> current-output-layout-struts-bottom: 0;
    in-out property <int> current-output-layout-center-index: 0;  // 0=Never, 1=OnOverflow, 2=Always

    // New output name input
    in-out property <string> new-output-name: "";

    // Callbacks
    callback add-output(string);
    callback remove-output(int);
    callback select-output(int);
    callback discover-outputs();
    callback output-enabled-toggled(bool);
    callback output-scale-changed(float);
    callback output-mode-changed(string);
    callback output-mode-selected(int);  // Mode selected from dropdown
    callback use-custom-mode-toggled(bool);  // Toggle custom mode input
    callback output-pos-x-changed(int);
    callback output-pos-y-changed(int);
    callback output-transform-changed(int);
    callback output-vrr-changed(int);

    // Phase 8 callbacks
    callback output-mode-custom-toggled(bool);
    callback output-modeline-changed(string);
    callback output-hc-override-toggled(bool);
    callback output-hc-enabled-toggled(bool);
    callback output-hc-top-left-toggled(bool);
    callback output-hc-top-right-toggled(bool);
    callback output-hc-bottom-left-toggled(bool);
    callback output-hc-bottom-right-toggled(bool);
    callback output-layout-override-toggled(bool);
    callback output-layout-gaps-inner-changed(float);
    callback output-layout-gaps-outer-changed(float);
    callback output-layout-struts-left-changed(float);
    callback output-layout-struts-right-changed(float);
    callback output-layout-struts-top-changed(float);
    callback output-layout-struts-bottom-changed(float);
    callback output-layout-center-changed(int);

    // Internal state for confirmation dialog
    property <bool> show-custom-mode-confirm: false;

    background: transparent;

    ScrollView {
        VerticalLayout {
            alignment: start;
            spacing: Theme.spacing-lg;
            padding-right: Theme.spacing-md;

            // Add Output Section
            SettingsSection {
                title: "ADD OUTPUT";

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    // Full-width layout for output name input
                    VerticalLayout {
                        spacing: Theme.spacing-xs;

                        Text {
                            text: "Output name";
                            color: Theme.text-primary;
                            font-size: Theme.font-size-md;
                        }

                        Text {
                            text: "Enter the output name (e.g., eDP-1, HDMI-A-1, DP-2)";
                            color: Theme.text-muted;
                            font-size: Theme.font-size-sm;
                        }

                        HorizontalLayout {
                            spacing: Theme.spacing-sm;

                            LineEdit {
                                horizontal-stretch: 1;
                                text: root.new-output-name;
                                placeholder-text: "e.g., HDMI-A-1";

                                accessible-role: text-input;
                                accessible-label: "New output name";

                                edited(value) => { root.new-output-name = value; }
                            }

                            Button {
                                text: "Add";
                                enabled: root.new-output-name != "";
                                accessible-label: "Add output";
                                clicked => {
                                    if root.new-output-name != "" {
                                        root.add-output(root.new-output-name);
                                        root.new-output-name = "";
                                    }
                                }
                            }
                        }
                    }

                    // Discover button
                    HorizontalLayout {
                        spacing: Theme.spacing-sm;

                        Button {
                            text: "Discover from niri";
                            accessible-label: "Discover connected outputs from niri";
                            clicked => { root.discover-outputs(); }
                        }

                        Text {
                            text: "Auto-detect connected displays";
                            color: Theme.text-muted;
                            font-size: Theme.font-size-sm;
                            vertical-alignment: center;
                        }
                    }

                    // Discovered outputs (click to add)
                    if root.discovered-outputs.length > 0: VerticalLayout {
                        spacing: Theme.spacing-xs;

                        Text {
                            text: "Discovered outputs (click to add):";
                            color: Theme.text-secondary;
                            font-size: Theme.font-size-sm;
                        }

                        HorizontalLayout {
                            spacing: Theme.spacing-xs;

                            for discovered[idx] in root.discovered-outputs : Rectangle {
                                height: 28px;
                                min-width: 80px;
                                background: touch.has-hover ? Theme.accent.with-alpha(0.2) : Theme.background;
                                border-radius: Theme.radius-sm;
                                border-width: 1px;
                                border-color: Theme.border;

                                touch := TouchArea {
                                    accessible-role: button;
                                    accessible-label: "Add discovered output: " + discovered;

                                    clicked => {
                                        root.add-output(discovered);
                                    }
                                }

                                HorizontalLayout {
                                    padding-left: Theme.spacing-sm;
                                    padding-right: Theme.spacing-sm;
                                    alignment: center;

                                    Text {
                                        text: discovered;
                                        color: Theme.text-primary;
                                        font-size: Theme.font-size-sm;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Configured Outputs Section
            SettingsSection {
                title: "CONFIGURED OUTPUTS";

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    if root.output-list.length == 0: Text {
                        text: "No outputs configured. Add an output above or click Discover.";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-md;
                    }

                    // Clickable output list
                    for output-name[index] in root.output-list : Rectangle {
                        height: 40px;
                        background: index == root.selected-output-index ? Theme.accent.with-alpha(0.2) : transparent;
                        border-radius: Theme.radius-sm;

                        TouchArea {
                            accessible-role: list-item;
                            accessible-label: "Output: " + output-name;

                            clicked => {
                                root.selected-output-index = index;
                                root.select-output(index);
                            }
                        }

                        HorizontalLayout {
                            padding-left: Theme.spacing-sm;
                            padding-right: Theme.spacing-sm;

                            Text {
                                text: output-name;
                                color: index == root.selected-output-index ? Theme.accent : Theme.text-primary;
                                font-size: Theme.font-size-md;
                                vertical-alignment: center;
                                horizontal-stretch: 1;
                            }

                            if index == root.selected-output-index: Button {
                                text: "×";
                                accessible-label: "Remove output";
                                clicked => { root.remove-output(index); }
                            }
                        }
                    }
                }
            }

            // Selected Output Settings
            if root.selected-output-index >= 0 && root.current-output-name != "": SettingsSection {
                title: "OUTPUT: " + root.current-output-name;

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    ToggleRow {
                        label: "Enabled";
                        description: "Enable or disable this output";
                        checked: root.current-output-enabled;
                        toggled(val) => { root.current-output-enabled = val; root.output-enabled-toggled(val); }
                    }

                    if root.current-output-enabled: VerticalLayout {
                        spacing: Theme.spacing-sm;

                        // Scale setting
                        PercentageSliderRow {
                            label: "Scale";
                            description: "Display scaling factor (1.0 = 100%)";
                            suffix: "x";
                            minimum: 50;
                            maximum: 300;
                            value: root.current-output-scale;
                            changed(val) => {
                                root.current-output-scale = val;
                                root.output-scale-changed(val);
                            }
                        }

                        // Mode setting (resolution@refresh) - ComboBox when modes available
                        SettingRow {
                            label: "Resolution";
                            description: root.available-modes.length > 0
                                ? "Select from available display modes"
                                : "Enter resolution and refresh rate";

                            HorizontalLayout {
                                spacing: Theme.spacing-sm;

                                // Fallback to text input when no modes or custom mode enabled
                                if root.available-modes.length == 0 || root.use-custom-mode: LineEdit {
                                    width: Theme.input-width-xl;
                                    text: root.current-output-mode;
                                    placeholder-text: "1920x1080@60.00";

                                    accessible-role: text-input;
                                    accessible-label: "Output mode";

                                    edited(text) => { root.current-output-mode = text; root.output-mode-changed(text); }
                                }

                                // Show ComboBox when modes are available and not using custom
                                if root.available-modes.length > 0 && !root.use-custom-mode: ComboBox {
                                    width: Theme.input-width-xl;
                                    model: root.available-modes;
                                    current-index: root.selected-mode-index >= 0 ? root.selected-mode-index : 0;

                                    selected(value) => {
                                        // Find index of selected value and notify
                                        root.output-mode-selected(self.current-index);
                                        root.selected-mode-index = self.current-index;
                                    }
                                }

                                // Custom mode toggle button (only show when modes are available)
                                if root.available-modes.length > 0: Rectangle {
                                    width: 32px;
                                    height: Theme.control-height;
                                    border-radius: Theme.radius-sm;
                                    background: root.use-custom-mode ? Theme.accent : Theme.control-background;
                                    border-width: root.use-custom-mode ? 0px : 1px;
                                    border-color: custom-mode-touch.has-hover ? Theme.border-focus : Theme.border;

                                    custom-mode-touch := TouchArea {
                                        clicked => {
                                            root.use-custom-mode = !root.use-custom-mode;
                                            root.use-custom-mode-toggled(root.use-custom-mode);
                                        }
                                    }

                                    Text {
                                        text: "✎";
                                        color: root.use-custom-mode ? Theme.accent-foreground : Theme.text-secondary;
                                        font-size: 16px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }

                        // Position (use text input to allow negative values)
                        SettingRow {
                            label: "Position X";
                            description: "Horizontal position (use negative for left of origin)";

                            LineEdit {
                                width: Theme.input-width;
                                text: root.current-output-pos-x;
                                input-type: text;

                                accessible-role: text-input;
                                accessible-label: "Position X";

                                edited(text) => {
                                    root.output-pos-x-changed(Math.round(text.to-float()));
                                }
                            }
                        }

                        SettingRow {
                            label: "Position Y";
                            description: "Vertical position (use negative for above origin)";

                            LineEdit {
                                width: Theme.input-width;
                                text: root.current-output-pos-y;
                                input-type: text;

                                accessible-role: text-input;
                                accessible-label: "Position Y";

                                edited(text) => {
                                    root.output-pos-y-changed(Math.round(text.to-float()));
                                }
                            }
                        }

                        // Transform
                        ComboBoxRow {
                            label: "Transform";
                            description: "Rotation and flip transformation";
                            model: ["Normal", "Rotate 90", "Rotate 180", "Rotate 270",
                                    "Flipped", "Flipped 90", "Flipped 180", "Flipped 270"];
                            current-index: root.current-output-transform-index;
                            selected(idx) => { root.current-output-transform-index = idx; root.output-transform-changed(idx); }
                        }

                        // VRR
                        ComboBoxRow {
                            label: "Variable Refresh Rate";
                            description: "Adaptive sync / FreeSync / G-Sync";
                            model: ["Off", "On", "On Demand"];
                            current-index: root.current-output-vrr-index;
                            selected(idx) => { root.current-output-vrr-index = idx; root.output-vrr-changed(idx); }
                        }
                    }
                }
            }

            // Advanced Mode Settings (Phase 8) - Only visible in Expert Mode
            if root.expert-mode && root.selected-output-index >= 0 && root.current-output-name != "" && root.current-output-enabled: SettingsSection {
                title: "ADVANCED MODE SETTINGS (EXPERT)";

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "⚠️ Warning: Custom modes may damage your monitor if used incorrectly";
                        color: Theme.warning;
                        font-size: Theme.font-size-sm;
                        wrap: word-wrap;
                    }

                    ToggleRow {
                        label: "Custom Modeline";
                        description: "Use a custom XFree86 modeline instead of standard display modes";
                        checked <=> root.current-output-mode-custom;  // Two-way binding for proper sync
                        toggled(val) => {
                            if val {
                                // Reset toggle immediately, will enable only on confirm
                                root.current-output-mode-custom = false;
                                root.show-custom-mode-confirm = true;
                            } else {
                                // Disable immediately without confirmation
                                root.output-mode-custom-toggled(false);
                            }
                        }
                    }

                    if root.current-output-mode-custom: SettingRow {
                        label: "Modeline";
                        description: "XFree86 modeline (e.g., 173.00 1920 2048 2248 2576 1080 1083 1088 1120 -hsync +vsync)";

                        LineEdit {
                            width: 300px;
                            text: root.current-output-modeline;
                            placeholder-text: "173.00 1920 2048 2248 2576 1080 1083 1088 1120 -hsync +vsync";

                            accessible-role: text-input;
                            accessible-label: "Modeline";

                            edited(text) => { root.current-output-modeline = text; root.output-modeline-changed(text); }
                        }
                    }
                }
            }

            // Per-Output Hot Corners (Phase 8)
            if root.selected-output-index >= 0 && root.current-output-name != "" && root.current-output-enabled: SettingsSection {
                title: "HOT CORNERS (PER-OUTPUT)";

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    ToggleRow {
                        label: "Custom Hot Corners";
                        description: "Override global hot corners for this output";
                        checked: root.current-output-hc-override-enabled;
                        toggled(val) => { root.current-output-hc-override-enabled = val; root.output-hc-override-toggled(val); }
                    }

                    if root.current-output-hc-override-enabled: VerticalLayout {
                        spacing: Theme.spacing-sm;

                        ToggleRow {
                            label: "Enable Hot Corners";
                            description: "Enable hot corners on this output";
                            checked: root.current-output-hot-corners-enabled;
                            toggled(val) => { root.current-output-hot-corners-enabled = val; root.output-hc-enabled-toggled(val); }
                        }

                        if root.current-output-hot-corners-enabled: VerticalLayout {
                            spacing: Theme.spacing-sm;

                            ToggleRow {
                                label: "Top Left";
                                description: "Activate overview on top-left corner";
                                checked: root.current-output-hc-top-left;
                                toggled(val) => { root.current-output-hc-top-left = val; root.output-hc-top-left-toggled(val); }
                            }

                            ToggleRow {
                                label: "Top Right";
                                description: "Activate overview on top-right corner";
                                checked: root.current-output-hc-top-right;
                                toggled(val) => { root.current-output-hc-top-right = val; root.output-hc-top-right-toggled(val); }
                            }

                            ToggleRow {
                                label: "Bottom Left";
                                description: "Activate overview on bottom-left corner";
                                checked: root.current-output-hc-bottom-left;
                                toggled(val) => { root.current-output-hc-bottom-left = val; root.output-hc-bottom-left-toggled(val); }
                            }

                            ToggleRow {
                                label: "Bottom Right";
                                description: "Activate overview on bottom-right corner";
                                checked: root.current-output-hc-bottom-right;
                                toggled(val) => { root.current-output-hc-bottom-right = val; root.output-hc-bottom-right-toggled(val); }
                            }
                        }
                    }
                }
            }

            // Per-Output Layout Override (Phase 8)
            if root.selected-output-index >= 0 && root.current-output-name != "" && root.current-output-enabled: SettingsSection {
                title: "LAYOUT OVERRIDE (PER-OUTPUT)";

                VerticalLayout {
                    spacing: Theme.spacing-sm;

                    ToggleRow {
                        label: "Custom Layout";
                        description: "Override global layout settings for this output";
                        checked: root.current-output-layout-override-enabled;
                        toggled(val) => { root.current-output-layout-override-enabled = val; root.output-layout-override-toggled(val); }
                    }

                    if root.current-output-layout-override-enabled: VerticalLayout {
                        spacing: Theme.spacing-sm;

                        SliderRow {
                            label: "Inner Gap";
                            description: "Space between windows on this output";
                            minimum: 0;
                            maximum: 64;
                            value: root.current-output-layout-gaps-inner;
                            changed(val) => { root.current-output-layout-gaps-inner = val; root.output-layout-gaps-inner-changed(val); }
                        }

                        SliderRow {
                            label: "Outer Gap";
                            description: "Space between windows and screen edges";
                            minimum: 0;
                            maximum: 64;
                            value: root.current-output-layout-gaps-outer;
                            changed(val) => { root.current-output-layout-gaps-outer = val; root.output-layout-gaps-outer-changed(val); }
                        }

                        Text {
                            text: "Struts (reserved screen edges)";
                            color: Theme.text-secondary;
                            font-size: Theme.font-size-sm;
                        }

                        SliderRow {
                            label: "Left Strut";
                            description: "Reserved space on left edge";
                            minimum: 0;
                            maximum: 200;
                            value: root.current-output-layout-struts-left;
                            changed(val) => { root.current-output-layout-struts-left = val; root.output-layout-struts-left-changed(val); }
                        }

                        SliderRow {
                            label: "Right Strut";
                            description: "Reserved space on right edge";
                            minimum: 0;
                            maximum: 200;
                            value: root.current-output-layout-struts-right;
                            changed(val) => { root.current-output-layout-struts-right = val; root.output-layout-struts-right-changed(val); }
                        }

                        SliderRow {
                            label: "Top Strut";
                            description: "Reserved space on top edge";
                            minimum: 0;
                            maximum: 200;
                            value: root.current-output-layout-struts-top;
                            changed(val) => { root.current-output-layout-struts-top = val; root.output-layout-struts-top-changed(val); }
                        }

                        SliderRow {
                            label: "Bottom Strut";
                            description: "Reserved space on bottom edge";
                            minimum: 0;
                            maximum: 200;
                            value: root.current-output-layout-struts-bottom;
                            changed(val) => { root.current-output-layout-struts-bottom = val; root.output-layout-struts-bottom-changed(val); }
                        }

                        ComboBoxRow {
                            label: "Center Focused Column";
                            description: "Centering behavior for the focused column";
                            model: ["Never", "On Overflow", "Always"];
                            current-index: root.current-output-layout-center-index;
                            selected(idx) => { root.current-output-layout-center-index = idx; root.output-layout-center-changed(idx); }
                        }
                    }
                }
            }

            // Info section
            SettingsSection {
                title: "INFORMATION";

                VerticalLayout {
                    spacing: Theme.spacing-xs;

                    Text {
                        text: "Output names are connector identifiers like:";
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-sm;
                    }
                    Text {
                        text: "  eDP-1 - Built-in laptop display";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                    }
                    Text {
                        text: "  HDMI-A-1, HDMI-A-2 - HDMI ports";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                    }
                    Text {
                        text: "  DP-1, DP-2 - DisplayPort";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                    }
                    Text {
                        text: "  USB-C-1 - USB-C video output";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                    }
                }
            }

            // Spacer at bottom
            Rectangle {
                height: Theme.spacing-lg;
            }
        }
    }

    // Confirmation dialog for custom modeline
    ConfirmDialog {
        show-dialog: root.show-custom-mode-confirm;
        title: "Enable Custom Modeline?";
        message: "Custom modelines can cause your monitor to turn off or display incorrectly.";
        warning: "Using incorrect modelines can potentially damage your monitor. Only proceed if you know what you're doing and have a valid modeline.\n\nTo recover: Edit ~/.config/niri/niri-settings/outputs.kdl and remove the 'custom' and 'modeline' lines.";
        confirm-text: "Enable Custom Modeline";
        cancel-text: "Cancel";

        confirmed => {
            root.show-custom-mode-confirm = false;
            root.current-output-mode-custom = true;
            root.output-mode-custom-toggled(true);
        }

        cancelled => {
            root.show-custom-mode-confirm = false;
            // Toggle stays off since we didn't confirm
        }
    }
}
