// Dynamic Switch Events settings page
// Uses model-driven rendering for reduced compile time

import { Theme } from "../styles.slint";
import { ScrollView, LineEdit, Button, Switch, Slider, ComboBox } from "std-widgets.slint";
import { SettingsSection } from "../widgets/section.slint";

// Universal setting model for switch events
export struct SwitchEventSettingModel {
    id: string,              // Unique identifier for callbacks
    label: string,           // Display label
    description: string,     // Help text
    setting-type: int,       // 0=toggle, 1=slider, 2=combo, 3=text

    // Toggle (type 0)
    bool-value: bool,

    // Slider (type 1)
    int-value: int,
    float-value: float,
    min-value: float,
    max-value: float,
    suffix: string,
    use-float: bool,         // true = float slider, false = int slider

    // ComboBox (type 2)
    combo-index: int,
    combo-options: [string],

    // Text (type 3)
    text-value: string,
    placeholder: string,

    // Visibility
    visible: bool,
}

// Dynamic row component - renders any setting type
component DynamicRow inherits Rectangle {
    in property <SwitchEventSettingModel> setting;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback combo-changed(string, int);
    callback text-changed(string, string);

    visible: setting.visible;
    height: setting.visible ? 52px : 0;
    background: transparent;

    HorizontalLayout {
        spacing: Theme.spacing-md;
        padding: Theme.spacing-xs;
        padding-left: Theme.spacing-md;
        padding-right: Theme.spacing-md;

        // Label column
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;
            alignment: center;

            Text {
                text: setting.label;
                color: Theme.text-primary;
                font-size: Theme.font-size-sm;
                font-weight: 500;
            }

            if setting.description != "": Text {
                text: setting.description;
                color: Theme.text-muted;
                font-size: Theme.font-size-xs;
                wrap: word-wrap;
            }
        }

        // Control column
        Rectangle {
            width: 200px;
            vertical-stretch: 1;

            // Toggle (type 0)
            if setting.setting-type == 0: HorizontalLayout {
                alignment: end;
                padding-right: Theme.spacing-sm;

                Switch {
                    checked: setting.bool-value;
                    toggled => {
                        root.toggle-changed(setting.id, self.checked);
                    }
                }
            }

            // Slider (type 1)
            if setting.setting-type == 1: HorizontalLayout {
                spacing: Theme.spacing-sm;
                alignment: center;

                Slider {
                    horizontal-stretch: 1;
                    minimum: setting.min-value;
                    maximum: setting.max-value;
                    value: setting.use-float ? setting.float-value : setting.int-value;
                    changed(val) => {
                        root.slider-int-changed(setting.id, round(val));
                    }
                }

                Text {
                    width: 55px;
                    text: setting.int-value + setting.suffix;
                    color: Theme.text-secondary;
                    font-size: Theme.font-size-sm;
                    horizontal-alignment: right;
                    vertical-alignment: center;
                }
            }

            // ComboBox (type 2)
            if setting.setting-type == 2: HorizontalLayout {
                alignment: end;

                ComboBox {
                    width: 140px;
                    model: setting.combo-options;
                    current-index: setting.combo-index;
                    selected(_) => {
                        root.combo-changed(setting.id, self.current-index);
                    }
                }
            }

            // Text input (type 3)
            if setting.setting-type == 3: HorizontalLayout {
                alignment: end;

                LineEdit {
                    width: 180px;
                    text: setting.text-value;
                    placeholder-text: setting.placeholder;
                    edited(val) => {
                        root.text-changed(setting.id, val);
                    }
                }
            }
        }
    }
}

// Dynamic section component
component DynamicSection inherits Rectangle {
    in property <string> title;
    in property <string> subtitle: "";
    in property <[SwitchEventSettingModel]> settings;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback combo-changed(string, int);
    callback text-changed(string, string);

    background: Theme.card-background;
    border-radius: Theme.radius-md;

    VerticalLayout {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-xs;

        // Section header
        Text {
            text: title;
            color: Theme.text-muted;
            font-size: Theme.font-size-xs;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        // Optional subtitle
        if subtitle != "": Text {
            text: subtitle;
            color: Theme.text-muted;
            font-size: Theme.font-size-sm;
            wrap: word-wrap;
        }

        // Dynamic rows from model
        for setting in settings: DynamicRow {
            setting: setting;
            toggle-changed(id, val) => { root.toggle-changed(id, val); }
            slider-int-changed(id, val) => { root.slider-int-changed(id, val); }
            combo-changed(id, val) => { root.combo-changed(id, val); }
            text-changed(id, val) => { root.text-changed(id, val); }
        }
    }
}

// Command list item component for displaying a command entry
component CommandListItem inherits Rectangle {
    in property <string> command;
    in property <int> index;
    in property <bool> is-selected;
    in property <string> event-id;

    callback item-selected(string, int);
    callback item-remove(string, int);

    height: 36px;
    background: is-selected ? Theme.accent.with-alpha(0.2) : transparent;
    border-radius: Theme.radius-sm;

    TouchArea {
        accessible-role: list-item;
        accessible-label: "Command: " + command;

        clicked => {
            root.item-selected(event-id, index);
        }
    }

    HorizontalLayout {
        padding-left: Theme.spacing-sm;
        padding-right: Theme.spacing-sm;

        Text {
            text: command;
            color: is-selected ? Theme.accent : Theme.text-primary;
            font-size: Theme.font-size-sm;
            vertical-alignment: center;
            horizontal-stretch: 1;
            overflow: elide;
        }

        if is-selected: Button {
            text: "x";
            accessible-label: "Remove command";
            clicked => { root.item-remove(event-id, index); }
        }
    }
}

// Command list section for a single switch event type
component CommandListSection inherits Rectangle {
    in property <string> title;
    in property <string> description;
    in property <string> event-id;
    in property <[string]> commands: [];
    in property <int> selected-index: -1;
    in property <string> current-text: "";
    in property <string> placeholder: "";

    callback command-add(string, string);
    callback command-remove(string, int);
    callback command-select(string, int);
    callback command-text-changed(string, string);

    background: Theme.card-background;
    border-radius: Theme.radius-md;

    VerticalLayout {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-sm;

        // Section header
        Text {
            text: title;
            color: Theme.text-muted;
            font-size: Theme.font-size-xs;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        Text {
            text: description;
            color: Theme.text-muted;
            font-size: Theme.font-size-sm;
            wrap: word-wrap;
        }

        // Command list
        Rectangle {
            background: Theme.background;
            border-radius: Theme.radius-sm;
            height: cmd-list.preferred-height + Theme.spacing-sm * 2;

            cmd-list := VerticalLayout {
                padding: Theme.spacing-sm;
                spacing: Theme.spacing-xs;

                for cmd[index] in root.commands : CommandListItem {
                    command: cmd;
                    index: index;
                    is-selected: index == root.selected-index;
                    event-id: root.event-id;
                    item-selected(eid, idx) => { root.command-select(eid, idx); }
                    item-remove(eid, idx) => { root.command-remove(eid, idx); }
                }

                if root.commands.length == 0: Text {
                    text: "No commands configured";
                    color: Theme.text-muted;
                    font-size: Theme.font-size-sm;
                    horizontal-alignment: center;
                }
            }
        }

        // Add/Edit controls
        HorizontalLayout {
            spacing: Theme.spacing-sm;

            LineEdit {
                horizontal-stretch: 1;
                text: root.current-text;
                placeholder-text: root.placeholder;
                edited(value) => {
                    root.command-text-changed(root.event-id, value);
                }
            }

            Button {
                text: "Add";
                accessible-label: "Add command";
                clicked => { root.command-add(root.event-id, root.current-text); }
            }
        }
    }
}

// Main page component
export component SwitchEventsDynamicPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Switch events settings";

    // Lid close commands
    in-out property <[string]> lid-close-commands: [];
    in-out property <int> lid-close-selected: -1;
    in-out property <string> lid-close-current: "";

    // Lid open commands
    in-out property <[string]> lid-open-commands: [];
    in-out property <int> lid-open-selected: -1;
    in-out property <string> lid-open-current: "";

    // Tablet mode on commands
    in-out property <[string]> tablet-mode-on-commands: [];
    in-out property <int> tablet-mode-on-selected: -1;
    in-out property <string> tablet-mode-on-current: "";

    // Tablet mode off commands
    in-out property <[string]> tablet-mode-off-commands: [];
    in-out property <int> tablet-mode-off-selected: -1;
    in-out property <string> tablet-mode-off-current: "";

    // Dynamic settings models (for potential future non-list settings)
    in-out property <[SwitchEventSettingModel]> general-settings: [];

    // Generic command callbacks - dispatched by event-id
    callback command-add(string, string);         // (event-id, command-text)
    callback command-remove(string, int);         // (event-id, index)
    callback command-select(string, int);         // (event-id, index)
    callback command-text-changed(string, string); // (event-id, new-text)

    // Generic setting callbacks (for potential future settings)
    callback setting-toggle-changed(string, bool);
    callback setting-slider-int-changed(string, int);
    callback setting-combo-changed(string, int);
    callback setting-text-changed(string, string);

    background: transparent;

    ScrollView {
        VerticalLayout {
            alignment: start;
            spacing: Theme.spacing-lg;
            padding-right: Theme.spacing-md;

            // Info banner
            Rectangle {
                background: Theme.card-background;
                border-radius: Theme.radius-md;
                height: info-layout.preferred-height + Theme.spacing-md * 2;

                info-layout := VerticalLayout {
                    padding: Theme.spacing-md;
                    spacing: Theme.spacing-xs;

                    Text {
                        text: "Hardware Switch Events";
                        color: Theme.text-primary;
                        font-size: Theme.font-size-lg;
                        font-weight: 600;
                    }

                    Text {
                        text: "Configure commands to run when hardware switches change state. These are typically laptop lid and tablet mode switches. Commands are spawned as separate processes.";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                        wrap: word-wrap;
                    }
                }
            }

            // General settings section (if any non-list settings exist)
            if root.general-settings.length > 0: DynamicSection {
                title: "GENERAL";
                settings: root.general-settings;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
                text-changed(id, val) => { root.setting-text-changed(id, val); }
            }

            // Lid Close Section
            CommandListSection {
                title: "LID CLOSE";
                description: "Commands to run when the laptop lid is closed";
                event-id: "lid_close";
                commands: root.lid-close-commands;
                selected-index: root.lid-close-selected;
                current-text: root.lid-close-current;
                placeholder: "e.g., swaylock";
                command-add(eid, cmd) => { root.command-add(eid, cmd); }
                command-remove(eid, idx) => { root.command-remove(eid, idx); }
                command-select(eid, idx) => { root.command-select(eid, idx); }
                command-text-changed(eid, text) => { root.command-text-changed(eid, text); }
            }

            // Lid Open Section
            CommandListSection {
                title: "LID OPEN";
                description: "Commands to run when the laptop lid is opened";
                event-id: "lid_open";
                commands: root.lid-open-commands;
                selected-index: root.lid-open-selected;
                current-text: root.lid-open-current;
                placeholder: "e.g., killall swaylock";
                command-add(eid, cmd) => { root.command-add(eid, cmd); }
                command-remove(eid, idx) => { root.command-remove(eid, idx); }
                command-select(eid, idx) => { root.command-select(eid, idx); }
                command-text-changed(eid, text) => { root.command-text-changed(eid, text); }
            }

            // Tablet Mode On Section
            CommandListSection {
                title: "TABLET MODE ON";
                description: "Commands to run when tablet mode is activated";
                event-id: "tablet_mode_on";
                commands: root.tablet-mode-on-commands;
                selected-index: root.tablet-mode-on-selected;
                current-text: root.tablet-mode-on-current;
                placeholder: "e.g., onboard";
                command-add(eid, cmd) => { root.command-add(eid, cmd); }
                command-remove(eid, idx) => { root.command-remove(eid, idx); }
                command-select(eid, idx) => { root.command-select(eid, idx); }
                command-text-changed(eid, text) => { root.command-text-changed(eid, text); }
            }

            // Tablet Mode Off Section
            CommandListSection {
                title: "TABLET MODE OFF";
                description: "Commands to run when tablet mode is deactivated";
                event-id: "tablet_mode_off";
                commands: root.tablet-mode-off-commands;
                selected-index: root.tablet-mode-off-selected;
                current-text: root.tablet-mode-off-current;
                placeholder: "e.g., killall onboard";
                command-add(eid, cmd) => { root.command-add(eid, cmd); }
                command-remove(eid, idx) => { root.command-remove(eid, idx); }
                command-select(eid, idx) => { root.command-select(eid, idx); }
                command-text-changed(eid, text) => { root.command-text-changed(eid, text); }
            }

            // Spacer at bottom
            Rectangle { height: Theme.spacing-lg; }
        }
    }
}
