// Dynamic Recent Windows settings page
// Uses model-driven rendering for reduced compile time

import { Theme } from "../styles.slint";
import { ScrollView, LineEdit, ComboBox, Slider, Switch } from "std-widgets.slint";
import { SettingsSection } from "../widgets/section.slint";

// Color preset with hex value for proper sync
struct ColorPreset {
    col: color,
    hex: string,
}

// Common color presets (Material Design inspired + Catppuccin)
global RecentWindowsColorPresets {
    out property <[ColorPreset]> palette: [
        { col: #f44336, hex: "#f44336" },
        { col: #e91e63, hex: "#e91e63" },
        { col: #9c27b0, hex: "#9c27b0" },
        { col: #673ab7, hex: "#673ab7" },
        { col: #3f51b5, hex: "#3f51b5" },
        { col: #2196f3, hex: "#2196f3" },
        { col: #03a9f4, hex: "#03a9f4" },
        { col: #00bcd4, hex: "#00bcd4" },
        { col: #009688, hex: "#009688" },
        { col: #4caf50, hex: "#4caf50" },
        { col: #8bc34a, hex: "#8bc34a" },
        { col: #cddc39, hex: "#cddc39" },
        { col: #ffeb3b, hex: "#ffeb3b" },
        { col: #ffc107, hex: "#ffc107" },
        { col: #ff9800, hex: "#ff9800" },
        { col: #ff5722, hex: "#ff5722" },
        { col: #795548, hex: "#795548" },
        { col: #9e9e9e, hex: "#9e9e9e" },
        { col: #607d8b, hex: "#607d8b" },
        { col: #7fc8ff, hex: "#7fc8ff" },
        { col: #eb6f92, hex: "#eb6f92" },
        { col: #1e1e2e, hex: "#1e1e2e" },
        { col: #313244, hex: "#313244" },
        { col: #45475a, hex: "#45475a" },
    ];
}

// Universal setting model for recent windows settings
export struct RecentWindowsSettingModel {
    id: string,              // Unique identifier for callbacks
    label: string,           // Display label
    description: string,     // Help text
    setting-type: int,       // 0=toggle, 1=slider, 2=combo, 3=text, 4=color

    // Toggle (type 0)
    bool-value: bool,

    // Slider (type 1)
    int-value: int,
    float-value: float,
    min-value: float,
    max-value: float,
    suffix: string,
    use-float: bool,         // true = float slider, false = int slider

    // ComboBox (type 2)
    combo-index: int,
    combo-options: [string],

    // Text/Color (type 3, 4)
    text-value: string,
    placeholder: string,
    color-value: color,      // Actual color value for preview

    // Visibility
    visible: bool,
}

// Dynamic row component - renders any setting type
component DynamicRow inherits Rectangle {
    in property <RecentWindowsSettingModel> setting;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback slider-float-changed(string, float);
    callback combo-changed(string, int);
    callback text-changed(string, string);
    callback color-changed(string, color);

    visible: setting.visible;
    height: setting.visible ? (setting.setting-type == 4 && swatches-expanded ? 88px : 52px) : 0;
    background: transparent;

    // State for color picker swatches
    property <bool> swatches-expanded: false;

    VerticalLayout {
        spacing: Theme.spacing-xs;

        HorizontalLayout {
            spacing: Theme.spacing-md;
            padding: Theme.spacing-xs;
            padding-left: Theme.spacing-md;
            padding-right: Theme.spacing-md;

            // Label column
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 2px;
                alignment: center;

                Text {
                    text: setting.label;
                    color: Theme.text-primary;
                    font-size: Theme.font-size-sm;
                    font-weight: 500;
                }

                if setting.description != "": Text {
                    text: setting.description;
                    color: Theme.text-muted;
                    font-size: Theme.font-size-xs;
                    wrap: word-wrap;
                }
            }

            // Control column
            Rectangle {
                width: 200px;
                vertical-stretch: 1;

                // Toggle (type 0)
                if setting.setting-type == 0: HorizontalLayout {
                    alignment: end;
                    padding-right: Theme.spacing-sm;

                    Switch {
                        checked: setting.bool-value;
                        toggled => {
                            root.toggle-changed(setting.id, self.checked);
                        }
                    }
                }

                // Slider (type 1)
                if setting.setting-type == 1: HorizontalLayout {
                    spacing: Theme.spacing-sm;
                    alignment: center;

                    Slider {
                        horizontal-stretch: 1;
                        minimum: setting.min-value;
                        maximum: setting.max-value;
                        value: setting.use-float ? setting.float-value : setting.int-value;
                        changed(val) => {
                            if (setting.use-float) {
                                root.slider-float-changed(setting.id, val);
                            } else {
                                root.slider-int-changed(setting.id, round(val));
                            }
                        }
                    }

                    Text {
                        width: 55px;
                        text: setting.use-float
                            ? round(setting.float-value * 100) / 100 + setting.suffix
                            : setting.int-value + setting.suffix;
                        color: Theme.text-secondary;
                        font-size: Theme.font-size-sm;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                // ComboBox (type 2)
                if setting.setting-type == 2: HorizontalLayout {
                    alignment: end;

                    ComboBox {
                        width: 140px;
                        model: setting.combo-options;
                        current-index: setting.combo-index;
                        selected(_) => {
                            root.combo-changed(setting.id, self.current-index);
                        }
                    }
                }

                // Text input (type 3)
                if setting.setting-type == 3: HorizontalLayout {
                    alignment: end;

                    LineEdit {
                        width: 180px;
                        text: setting.text-value;
                        placeholder-text: setting.placeholder;
                        edited(val) => {
                            root.text-changed(setting.id, val);
                        }
                    }
                }

                // Color input (type 4)
                if setting.setting-type == 4: HorizontalLayout {
                    alignment: end;
                    spacing: Theme.spacing-sm;

                    // Color preview swatch - click to toggle swatches
                    Rectangle {
                        width: 28px;
                        height: 28px;
                        background: transparent;
                        border-radius: Theme.radius-md;
                        border-width: 2px;
                        border-color: setting.color-value.with-alpha(0.5);

                        Rectangle {
                            x: 2px;
                            y: 2px;
                            width: 24px;
                            height: 24px;
                            background: setting.color-value;
                            border-radius: Theme.radius-sm;
                        }

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                root.swatches-expanded = !root.swatches-expanded;
                            }
                        }
                    }

                    LineEdit {
                        width: 100px;
                        text: setting.text-value;
                        placeholder-text: "#RRGGBB";
                        edited(val) => {
                            root.text-changed(setting.id, val);
                        }
                    }
                }
            }
        }

        // Expandable swatches row for color picker
        if setting.setting-type == 4 && swatches-expanded: Rectangle {
            height: 36px;
            background: transparent;

            HorizontalLayout {
                padding-left: Theme.spacing-sm;
                padding-right: Theme.spacing-sm;
                spacing: 4px;
                alignment: start;

                for preset in RecentWindowsColorPresets.palette: Rectangle {
                    width: 24px;
                    height: 24px;
                    background: preset.col;
                    border-radius: 4px;
                    border-width: swatch-touch.has-hover ? 2px : 1px;
                    border-color: swatch-touch.has-hover ? Theme.accent : Theme.border.with-alpha(0.5);

                    swatch-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            root.color-changed(setting.id, preset.col);
                            root.swatches-expanded = false;
                        }
                    }

                    animate border-width { duration: 100ms; }
                    animate border-color { duration: 100ms; }
                }
            }
        }
    }

    animate height { duration: 150ms; easing: ease-out; }
}

// Dynamic section component
component DynamicSection inherits Rectangle {
    in property <string> title;
    in property <string> subtitle: "";
    in property <[RecentWindowsSettingModel]> settings;
    in property <bool> section-visible: true;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback slider-float-changed(string, float);
    callback combo-changed(string, int);
    callback text-changed(string, string);
    callback color-changed(string, color);

    visible: section-visible;
    background: Theme.card-background;
    border-radius: Theme.radius-md;

    VerticalLayout {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-xs;

        // Section header
        Text {
            text: title;
            color: Theme.text-muted;
            font-size: Theme.font-size-xs;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        // Optional subtitle
        if subtitle != "": Text {
            text: subtitle;
            color: Theme.text-muted;
            font-size: Theme.font-size-sm;
            wrap: word-wrap;
        }

        // Dynamic rows from model
        for setting in settings: DynamicRow {
            setting: setting;
            toggle-changed(id, val) => { root.toggle-changed(id, val); }
            slider-int-changed(id, val) => { root.slider-int-changed(id, val); }
            slider-float-changed(id, val) => { root.slider-float-changed(id, val); }
            combo-changed(id, val) => { root.combo-changed(id, val); }
            text-changed(id, val) => { root.text-changed(id, val); }
            color-changed(id, val) => { root.color-changed(id, val); }
        }
    }
}

// Main page component
export component RecentWindowsDynamicPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Recent windows settings";

    // Feature enabled state (controls section visibility)
    in-out property <bool> feature-enabled: true;

    // Dynamic settings models for each section
    in-out property <[RecentWindowsSettingModel]> general-settings: [];
    in-out property <[RecentWindowsSettingModel]> highlight-settings: [];
    in-out property <[RecentWindowsSettingModel]> preview-settings: [];

    // Generic setting callbacks
    callback setting-toggle-changed(string, bool);
    callback setting-slider-int-changed(string, int);
    callback setting-slider-float-changed(string, float);
    callback setting-combo-changed(string, int);
    callback setting-text-changed(string, string);
    callback setting-color-changed(string, color);

    background: transparent;

    ScrollView {
        VerticalLayout {
            alignment: start;
            spacing: Theme.spacing-lg;
            padding-right: Theme.spacing-md;

            // General Settings Section (always visible - contains enable toggle)
            DynamicSection {
                title: "RECENT WINDOWS SWITCHER";
                subtitle: "Configure the Alt-Tab window switcher appearance and behavior (v25.05+)";
                settings: root.general-settings;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
                text-changed(id, val) => { root.setting-text-changed(id, val); }
                color-changed(id, val) => { root.setting-color-changed(id, val); }
            }

            // Highlight Settings Section (hidden when feature is disabled)
            DynamicSection {
                title: "HIGHLIGHT APPEARANCE";
                subtitle: "Customize the highlight appearance around selected windows";
                settings: root.highlight-settings;
                section-visible: root.feature-enabled;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
                text-changed(id, val) => { root.setting-text-changed(id, val); }
                color-changed(id, val) => { root.setting-color-changed(id, val); }
            }

            // Preview Settings Section (hidden when feature is disabled)
            DynamicSection {
                title: "WINDOW PREVIEWS";
                subtitle: "Configure the size of window preview thumbnails";
                settings: root.preview-settings;
                section-visible: root.feature-enabled;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
                text-changed(id, val) => { root.setting-text-changed(id, val); }
                color-changed(id, val) => { root.setting-color-changed(id, val); }
            }

            // Spacer at bottom
            Rectangle {
                height: Theme.spacing-lg;
            }
        }
    }
}
