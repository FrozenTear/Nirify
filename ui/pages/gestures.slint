// Dynamic Gestures settings page
// Uses model-driven rendering for reduced compile time

import { Theme } from "../styles.slint";
import { ScrollView, Switch, Slider, ComboBox, LineEdit } from "std-widgets.slint";
import { SettingsSection } from "../widgets/section.slint";

// Universal setting model for gestures
export struct GestureSettingModel {
    id: string,              // Unique identifier for callbacks
    label: string,           // Display label
    description: string,     // Help text
    setting-type: int,       // 0=toggle, 1=slider, 2=combo, 3=text

    // Toggle (type 0)
    bool-value: bool,

    // Slider (type 1)
    int-value: int,
    float-value: float,
    min-value: float,
    max-value: float,
    suffix: string,
    use-float: bool,         // true = float slider, false = int slider

    // ComboBox (type 2)
    combo-index: int,
    combo-options: [string],

    // Text (type 3)
    text-value: string,
    placeholder: string,

    // Visibility
    visible: bool,
}

// Dynamic row component - renders any setting type
component DynamicRow inherits Rectangle {
    in property <GestureSettingModel> setting;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback slider-float-changed(string, float);
    callback combo-changed(string, int);
    callback text-changed(string, string);

    visible: setting.visible;
    height: setting.visible ? 52px : 0;
    background: transparent;

    HorizontalLayout {
        spacing: Theme.spacing-md;
        padding: Theme.spacing-xs;
        padding-left: Theme.spacing-md;
        padding-right: Theme.spacing-md;

        // Label column
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;
            alignment: center;

            Text {
                text: setting.label;
                color: Theme.text-primary;
                font-size: Theme.font-size-sm;
                font-weight: 500;
            }

            if setting.description != "": Text {
                text: setting.description;
                color: Theme.text-muted;
                font-size: Theme.font-size-xs;
                wrap: word-wrap;
            }
        }

        // Control column
        Rectangle {
            width: 200px;
            vertical-stretch: 1;

            // Toggle (type 0)
            if setting.setting-type == 0: HorizontalLayout {
                alignment: end;
                padding-right: Theme.spacing-sm;

                Switch {
                    checked: setting.bool-value;
                    toggled => {
                        root.toggle-changed(setting.id, self.checked);
                    }
                }
            }

            // Slider (type 1)
            if setting.setting-type == 1: HorizontalLayout {
                spacing: Theme.spacing-sm;
                alignment: center;

                Slider {
                    horizontal-stretch: 1;
                    minimum: setting.min-value;
                    maximum: setting.max-value;
                    value: setting.use-float ? setting.float-value : setting.int-value;
                    changed(val) => {
                        if (setting.use-float) {
                            root.slider-float-changed(setting.id, val);
                        } else {
                            root.slider-int-changed(setting.id, round(val));
                        }
                    }
                }

                Text {
                    width: 70px;
                    text: setting.use-float
                        ? round(setting.float-value * 100) + setting.suffix
                        : setting.int-value + setting.suffix;
                    color: Theme.text-secondary;
                    font-size: Theme.font-size-sm;
                    horizontal-alignment: right;
                    vertical-alignment: center;
                }
            }

            // ComboBox (type 2)
            if setting.setting-type == 2: HorizontalLayout {
                alignment: end;

                ComboBox {
                    width: 140px;
                    model: setting.combo-options;
                    current-index: setting.combo-index;
                    selected(_) => {
                        root.combo-changed(setting.id, self.current-index);
                    }
                }
            }

            // Text input (type 3)
            if setting.setting-type == 3: HorizontalLayout {
                alignment: end;

                LineEdit {
                    width: 180px;
                    text: setting.text-value;
                    placeholder-text: setting.placeholder;
                    edited(val) => {
                        root.text-changed(setting.id, val);
                    }
                }
            }
        }
    }
}

// Dynamic section component
component DynamicSection inherits Rectangle {
    in property <string> title;
    in property <string> subtitle: "";
    in property <[GestureSettingModel]> settings;

    callback toggle-changed(string, bool);
    callback slider-int-changed(string, int);
    callback slider-float-changed(string, float);
    callback combo-changed(string, int);
    callback text-changed(string, string);

    background: Theme.card-background;
    border-radius: Theme.radius-md;

    VerticalLayout {
        padding: Theme.spacing-md;
        spacing: Theme.spacing-xs;

        // Section header
        Text {
            text: title;
            color: Theme.text-muted;
            font-size: Theme.font-size-xs;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        // Optional subtitle
        if subtitle != "": Text {
            text: subtitle;
            color: Theme.text-muted;
            font-size: Theme.font-size-sm;
            wrap: word-wrap;
        }

        // Dynamic rows from model
        for setting in settings: DynamicRow {
            setting: setting;
            toggle-changed(id, val) => { root.toggle-changed(id, val); }
            slider-int-changed(id, val) => { root.slider-int-changed(id, val); }
            slider-float-changed(id, val) => { root.slider-float-changed(id, val); }
            combo-changed(id, val) => { root.combo-changed(id, val); }
            text-changed(id, val) => { root.text-changed(id, val); }
        }
    }
}

// Hot corner selector component (visual grid)
component HotCornerSelector inherits Rectangle {
    in property <bool> enabled;
    in property <bool> top-left;
    in property <bool> top-right;
    in property <bool> bottom-left;
    in property <bool> bottom-right;

    callback corner-toggled(string, bool);

    visible: enabled;
    height: enabled ? 140px : 0;
    background: transparent;

    VerticalLayout {
        spacing: Theme.spacing-sm;

        Rectangle {
            height: 100px;
            background: Theme.card-background;
            border-radius: Theme.radius-md;

            // Corner grid
            GridLayout {
                padding: Theme.spacing-md;
                spacing: Theme.spacing-sm;

                Row {
                    // Top-left corner
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 36px;
                        background: root.top-left ? Theme.accent : Theme.background;
                        border-radius: Theme.radius-sm;
                        border-width: tl-focus.has-focus ? 2px : 0px;
                        border-color: Theme.border-focus;

                        accessible-role: checkbox;
                        accessible-label: "Top left hot corner";
                        accessible-checkable: true;
                        accessible-checked: root.top-left;

                        tl-focus := FocusScope {
                            key-pressed(event) => {
                                if (event.text == " " || event.text == "\n") {
                                    root.corner-toggled("top_left", !root.top-left);
                                    accept
                                }
                                reject
                            }
                        }

                        TouchArea {
                            clicked => {
                                tl-focus.focus();
                                root.corner-toggled("top_left", !root.top-left);
                            }
                        }

                        Text {
                            text: "Top Left";
                            color: root.top-left ? Theme.text-primary : Theme.text-muted;
                            font-size: Theme.font-size-xs;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            accessible-role: none;
                        }

                        animate border-width { duration: Theme.duration-fast; }
                    }

                    // Spacer
                    Rectangle { horizontal-stretch: 2; }

                    // Top-right corner
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 36px;
                        background: root.top-right ? Theme.accent : Theme.background;
                        border-radius: Theme.radius-sm;
                        border-width: tr-focus.has-focus ? 2px : 0px;
                        border-color: Theme.border-focus;

                        accessible-role: checkbox;
                        accessible-label: "Top right hot corner";
                        accessible-checkable: true;
                        accessible-checked: root.top-right;

                        tr-focus := FocusScope {
                            key-pressed(event) => {
                                if (event.text == " " || event.text == "\n") {
                                    root.corner-toggled("top_right", !root.top-right);
                                    accept
                                }
                                reject
                            }
                        }

                        TouchArea {
                            clicked => {
                                tr-focus.focus();
                                root.corner-toggled("top_right", !root.top-right);
                            }
                        }

                        Text {
                            text: "Top Right";
                            color: root.top-right ? Theme.text-primary : Theme.text-muted;
                            font-size: Theme.font-size-xs;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            accessible-role: none;
                        }

                        animate border-width { duration: Theme.duration-fast; }
                    }
                }

                Row {
                    // Bottom-left corner
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 36px;
                        background: root.bottom-left ? Theme.accent : Theme.background;
                        border-radius: Theme.radius-sm;
                        border-width: bl-focus.has-focus ? 2px : 0px;
                        border-color: Theme.border-focus;

                        accessible-role: checkbox;
                        accessible-label: "Bottom left hot corner";
                        accessible-checkable: true;
                        accessible-checked: root.bottom-left;

                        bl-focus := FocusScope {
                            key-pressed(event) => {
                                if (event.text == " " || event.text == "\n") {
                                    root.corner-toggled("bottom_left", !root.bottom-left);
                                    accept
                                }
                                reject
                            }
                        }

                        TouchArea {
                            clicked => {
                                bl-focus.focus();
                                root.corner-toggled("bottom_left", !root.bottom-left);
                            }
                        }

                        Text {
                            text: "Bottom Left";
                            color: root.bottom-left ? Theme.text-primary : Theme.text-muted;
                            font-size: Theme.font-size-xs;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            accessible-role: none;
                        }

                        animate border-width { duration: Theme.duration-fast; }
                    }

                    // Spacer
                    Rectangle { horizontal-stretch: 2; }

                    // Bottom-right corner
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 36px;
                        background: root.bottom-right ? Theme.accent : Theme.background;
                        border-radius: Theme.radius-sm;
                        border-width: br-focus.has-focus ? 2px : 0px;
                        border-color: Theme.border-focus;

                        accessible-role: checkbox;
                        accessible-label: "Bottom right hot corner";
                        accessible-checkable: true;
                        accessible-checked: root.bottom-right;

                        br-focus := FocusScope {
                            key-pressed(event) => {
                                if (event.text == " " || event.text == "\n") {
                                    root.corner-toggled("bottom_right", !root.bottom-right);
                                    accept
                                }
                                reject
                            }
                        }

                        TouchArea {
                            clicked => {
                                br-focus.focus();
                                root.corner-toggled("bottom_right", !root.bottom-right);
                            }
                        }

                        Text {
                            text: "Bottom Right";
                            color: root.bottom-right ? Theme.text-primary : Theme.text-muted;
                            font-size: Theme.font-size-xs;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            accessible-role: none;
                        }

                        animate border-width { duration: Theme.duration-fast; }
                    }
                }
            }
        }

        Text {
            text: "Click corners to toggle. Action: Toggle Overview";
            color: Theme.text-muted;
            font-size: Theme.font-size-sm;
            horizontal-alignment: center;
        }
    }
}

// Main page component
export component GesturesDynamicPage inherits Rectangle {
    accessible-role: none;
    accessible-label: "Gestures settings";

    // Hot corner selector state (separate from dynamic model for visual component)
    in-out property <bool> hot-corners-enabled: false;
    in-out property <bool> hot-corner-top-left: false;
    in-out property <bool> hot-corner-top-right: false;
    in-out property <bool> hot-corner-bottom-left: false;
    in-out property <bool> hot-corner-bottom-right: false;

    // Dynamic settings models
    in-out property <[GestureSettingModel]> hot-corners-settings: [];
    in-out property <[GestureSettingModel]> dnd-edge-scroll-settings: [];
    in-out property <[GestureSettingModel]> dnd-workspace-switch-settings: [];

    // Generic setting callbacks
    callback setting-toggle-changed(string, bool);
    callback setting-slider-int-changed(string, int);
    callback setting-slider-float-changed(string, float);
    callback setting-combo-changed(string, int);

    // Hot corner specific callback (for the visual selector)
    callback hot-corner-toggled(string, bool);

    background: transparent;

    ScrollView {
        VerticalLayout {
            alignment: start;
            spacing: Theme.spacing-lg;
            padding-right: Theme.spacing-md;

            // Hot Corners Section
            Rectangle {
                background: Theme.card-background;
                border-radius: Theme.radius-md;

                VerticalLayout {
                    padding: Theme.spacing-md;
                    spacing: Theme.spacing-sm;

                    Text {
                        text: "HOT CORNERS";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-xs;
                        font-weight: 600;
                        letter-spacing: 0.5px;
                    }

                    Text {
                        text: "Moving the cursor to screen corners can trigger the overview";
                        color: Theme.text-muted;
                        font-size: Theme.font-size-sm;
                        wrap: word-wrap;
                    }

                    // Dynamic rows for hot corners settings
                    for setting in root.hot-corners-settings: DynamicRow {
                        setting: setting;
                        toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                        slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                        slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                        combo-changed(id, val) => { root.setting-combo-changed(id, val); }
                    }

                    // Visual hot corner selector
                    HotCornerSelector {
                        enabled: root.hot-corners-enabled;
                        top-left: root.hot-corner-top-left;
                        top-right: root.hot-corner-top-right;
                        bottom-left: root.hot-corner-bottom-left;
                        bottom-right: root.hot-corner-bottom-right;
                        corner-toggled(corner, val) => { root.hot-corner-toggled(corner, val); }
                    }
                }
            }

            // DND Edge View Scroll Section
            DynamicSection {
                title: "DRAG-AND-DROP EDGE SCROLLING";
                subtitle: "When dragging items near screen edges, the view scrolls automatically";
                settings: root.dnd-edge-scroll-settings;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
            }

            // DND Workspace Switch Section
            DynamicSection {
                title: "DRAG-AND-DROP WORKSPACE SWITCHING";
                subtitle: "In overview, dragging near top/bottom edges switches workspaces";
                settings: root.dnd-workspace-switch-settings;
                toggle-changed(id, val) => { root.setting-toggle-changed(id, val); }
                slider-int-changed(id, val) => { root.setting-slider-int-changed(id, val); }
                slider-float-changed(id, val) => { root.setting-slider-float-changed(id, val); }
                combo-changed(id, val) => { root.setting-combo-changed(id, val); }
            }

            // Spacer at bottom
            Rectangle { height: Theme.spacing-lg; }
        }
    }
}
